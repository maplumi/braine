// Braine Visualizer UI - Minimal Spot Game
// Simple left/right discrimination task to test brain learning

import { VerticalBox, HorizontalBox, Button, Slider, CheckBox, TabWidget, GroupBox } from "std-widgets.slint";

// ═══════════════════════════════════════════════════════════════════════════
// Data structures
// ═══════════════════════════════════════════════════════════════════════════

export struct HudData {
    frame: int,
    trials: int,
    correct: int,
    incorrect: int,
    accuracy: float,
    recent-rate: float,
    last-100-rate: float,
    neuromod: float,
    learning-at-trial: int,
    learned-at-trial: int,
    mastered-at-trial: int,
}

export struct LearningState {
    learning-enabled: bool,
    attention-boost: float,
    attention-enabled: bool,
    burst-mode-enabled: bool,
    auto-dream-on-flip: bool,
    auto-burst-on-slump: bool,
    prediction-enabled: bool,
    prediction-weight: float,
}

export struct BrainStats {
    unit-count: int,
    connection-count: int,
    pruned-last-step: int,
    births-last-step: int,
    saturated: bool,
    avg-amp: float,
    avg-weight: float,
    memory-bytes: int,
    causal-base-symbols: int,
    causal-edges: int,
    causal-last-directed-updates: int,
    causal-last-cooccur-updates: int,
    age-steps: int,
}

export struct UnitPoint {
    id: int,
    amp: float,
    amp01: float,
    rel_age: float,
    is_reserved: bool,
    is_sensor_member: bool,
    is_group_member: bool,
}

export struct ActionScore {
    name: string,
    habit_norm: float,
    meaning_global: float,
    meaning_conditional: float,
    meaning: float,
    score: float,
}

export struct MeaningEdges {
    to-reward-pos: float,
    to-reward-neg: float,
    meaning: float,
}

export struct MeaningData {
    stimulus: string,
    correct-action: string,
    pair-left: MeaningEdges,
    pair-right: MeaningEdges,
    action-left: MeaningEdges,
    action-right: MeaningEdges,
    pair-gap: float,
    global-gap: float,
}

export struct MeaningHistDot {
    x01: float,
    v: float,
    positive: bool,
}

export struct GameState {
    spot-is-left: bool,
    response-made: bool,
    trial-frame: int,
    trial-duration: int,
}

// ═══════════════════════════════════════════════════════════════════════════
// Theme
// ═══════════════════════════════════════════════════════════════════════════

global Theme {
    out property <color> bg-dark: #0d0d10;
    out property <color> bg-panel: #1a1a1f;
    out property <color> border: #333340;
    out property <color> text-primary: #ffffff;
    out property <color> text-secondary: #888899;
    out property <color> accent-blue: #4080aa;
    out property <color> accent-green: #40aa60;
    out property <color> accent-red: #aa4040;
    out property <color> accent-yellow: #aaaa40;
}

// ═══════════════════════════════════════════════════════════════════════════
// Spot Game Canvas
// ═══════════════════════════════════════════════════════════════════════════

component SpotCanvas inherits Rectangle {
    in property <GameState> game;
    
    background: Theme.bg-dark;
    border-color: Theme.border;
    border-width: 2px;
    
    // Center divider
    Rectangle {
        x: parent.width / 2 - 1px;
        width: 2px;
        height: parent.height;
        background: #ffffff20;
    }
    
    // Left label
    Text {
        x: parent.width * 0.25 - 25px;
        y: 20px;
        text: "LEFT";
        color: Theme.text-secondary;
        font-size: 18px;
    }
    
    // Right label
    Text {
        x: parent.width * 0.75 - 30px;
        y: 20px;
        text: "RIGHT";
        color: Theme.text-secondary;
        font-size: 18px;
    }
    
    // Spot (bright yellow circle)
    Rectangle {
        x: (game.spot-is-left ? parent.width * 0.25 : parent.width * 0.75) - 40px;
        y: parent.height / 2 - 40px;
        width: 80px;
        height: 80px;
        background: Theme.accent-yellow;
        border-radius: 40px;
        opacity: game.response-made ? 0.25 : 1.0;
    }
    
    // Instruction text (when waiting for response)
    if !game.response-made: Text {
        x: 0px;
        y: parent.height - 40px;
        width: parent.width;
        text: game.spot-is-left ? "← Press LEFT (A)" : "Press RIGHT (D) →";
        color: Theme.text-primary;
        font-size: 16px;
        horizontal-alignment: center;
    }
    
    // Trial progress bar
    Rectangle {
        y: parent.height - 10px;
        x: game.spot-is-left ? 0px : parent.width / 2;
        width: game.trial-duration > 0 ? (
            (
                ((game.trial-frame * 1.0) / game.trial-duration) > 1.0 ? 1.0 :
                ((game.trial-frame * 1.0) / game.trial-duration) < 0.0 ? 0.0 :
                ((game.trial-frame * 1.0) / game.trial-duration)
            )
        ) * (parent.width / 2) : 0px;
        height: 4px;
        background: Theme.accent-blue;
    }
}

// ═══════════════════════════════════════════════════════════════════════════
// HUD Panel
// ═══════════════════════════════════════════════════════════════════════════

component HudPanel inherits Rectangle {
    in property <HudData> hud;
    
    background: Theme.bg-panel;
    border-color: Theme.border;
    border-width: 1px;
    border-radius: 6px;
    
    VerticalBox {
        padding: 10px;
        spacing: 4px;
        
        Text {
            text: "Frame: " + hud.frame + "  Trials: " + hud.trials;
            color: Theme.text-primary;
            font-size: 13px;
        }
        Text {
            text: "Correct: " + hud.correct + "  Incorrect: " + hud.incorrect + "  Accuracy: " + round(hud.accuracy * 100) + "%";
            color: Theme.text-primary;
            font-size: 13px;
        }
        Text {
            text: "Recent: " + round(hud.recent-rate * 100) + "%  Last 100: " + round(hud.last-100-rate * 100) + "%";
            color: hud.last-100-rate >= 0.85 ? Theme.accent-green : Theme.text-secondary;
            font-size: 13px;
        }
        Text {
            text: "Neuromodulator: " + round(hud.neuromod * 1000) / 1000;
            color: Theme.text-secondary;
            font-size: 12px;
        }
        
        // Learning milestones
        Text {
            text: hud.last-100-rate >= 0.95 ? "★★★ MASTERED" : 
                  hud.last-100-rate >= 0.85 ? "★★ LEARNED" :
                  hud.last-100-rate >= 0.70 ? "★ LEARNING" :
                  hud.trials < 20 ? "Starting..." : "Not yet learned";
            color: hud.last-100-rate >= 0.85 ? Theme.accent-green : Theme.accent-yellow;
            font-size: 14px;
            font-weight: 600;
        }

        Text {
            text: "Reached @ trials — Learning: " + (hud.learning-at-trial < 0 ? "-" : hud.learning-at-trial) +
                  "  Learned: " + (hud.learned-at-trial < 0 ? "-" : hud.learned-at-trial) +
                  "  Mastered: " + (hud.mastered-at-trial < 0 ? "-" : hud.mastered-at-trial);
            color: Theme.text-secondary;
            font-size: 12px;
        }
    }
}

// ═══════════════════════════════════════════════════════════════════════════
// Learning Panel
// ═══════════════════════════════════════════════════════════════════════════

component LearningPanel inherits Rectangle {
    in-out property <LearningState> state;
    
    callback trigger-dream();
    callback trigger-burst();
    callback trigger-sync();
    callback trigger-imprint();
    callback set-framerate(int);
    callback set-trial-period-ms(int);
    
    in-out property <int> framerate: 60;
    in-out property <int> trial-period-ms: 250;
    
    background: Theme.bg-panel;
    border-color: Theme.border;
    border-width: 1px;
    border-radius: 6px;
    
    VerticalBox {
        padding: 12px;
        spacing: 8px;
        
        Text {
            text: "Accelerated Learning";
            color: Theme.text-primary;
            font-size: 14px;
            font-weight: 600;
        }
        
        CheckBox {
            text: "Learning Enabled";
            checked: state.learning-enabled;
            toggled => { state.learning-enabled = self.checked; }
        }
        
        HorizontalBox {
            spacing: 6px;
            Button {
                text: "Dream";
                clicked => { trigger-dream(); }
            }
            Button {
                text: "Burst";
                clicked => { trigger-burst(); }
            }
            Button {
                text: "Sync";
                clicked => { trigger-sync(); }
            }
            Button {
                text: "Imprint";
                clicked => { trigger-imprint(); }
            }
        }
        
        Rectangle {
            height: 1px;
            background: Theme.border;
        }
        
        Text {
            text: "Simulation Speed";
            color: Theme.text-primary;
            font-size: 14px;
            font-weight: 600;
        }
        
        HorizontalBox {
            spacing: 8px;
            Text {
                text: "FPS: " + framerate;
                color: Theme.text-secondary;
                font-size: 12px;
                min-width: 60px;
            }
            Slider {
                minimum: 1;
                maximum: 120;
                value: framerate;
                changed(val) => {
                    framerate = val;
                    set-framerate(val);
                }
                horizontal-stretch: 1;
            }
            Button {
                text: "Reset";
                clicked => {
                    framerate = 60;
                    set-framerate(60);
                }
            }
        }

        HorizontalBox {
            spacing: 8px;
            Text {
                text: "Trial: " + trial-period-ms + "ms";
                color: Theme.text-secondary;
                font-size: 12px;
                min-width: 100px;
            }
            Slider {
                minimum: 50;
                maximum: 2000;
                value: trial-period-ms;
                changed(val) => {
                    trial-period-ms = val;
                    set-trial-period-ms(val);
                }
                horizontal-stretch: 1;
            }
            Button {
                text: "Reset";
                clicked => {
                    trial-period-ms = 250;
                    set-trial-period-ms(250);
                }
            }
        }
    }
}

// ═══════════════════════════════════════════════════════════════════════════
// Brain Stats Panel
// ═══════════════════════════════════════════════════════════════════════════

component BrainPanel inherits Rectangle {
    in property <BrainStats> stats;
    
    background: Theme.bg-panel;
    border-color: Theme.border;
    border-width: 1px;
    border-radius: 6px;
    
    VerticalBox {
        padding: 12px;
        spacing: 6px;
        
        Text {
            text: "Brain Substrate";
            color: Theme.text-primary;
            font-size: 14px;
            font-weight: 600;
        }
        Text { text: "Units: " + stats.unit-count; color: Theme.text-secondary; font-size: 12px; }
        Text { text: "Connections: " + stats.connection-count; color: Theme.text-secondary; font-size: 12px; }
        Text { text: "Pruned (last): " + stats.pruned-last-step; color: Theme.text-secondary; font-size: 12px; }
        Text { text: "Births (last): " + stats.births-last-step; color: Theme.text-secondary; font-size: 12px; }
        Text { text: "Saturated: " + (stats.saturated ? "yes" : "no"); color: stats.saturated ? Theme.accent-yellow : Theme.text-secondary; font-size: 12px; }
        Text { text: "Causal symbols: " + stats.causal-base-symbols; color: Theme.text-secondary; font-size: 12px; }
        Text { text: "Causal edges: " + stats.causal-edges; color: Theme.text-secondary; font-size: 12px; }
        Text { text: "Causal updates (last): " + stats.causal-last-directed-updates + " dir, " + stats.causal-last-cooccur-updates + " co"; color: Theme.text-secondary; font-size: 12px; }
        Text { text: "Avg amplitude: " + round(stats.avg-amp * 1000) / 1000; color: Theme.text-secondary; font-size: 12px; }
        Text { text: "Avg weight: " + round(stats.avg-weight * 1000) / 1000; color: Theme.text-secondary; font-size: 12px; }
        Text { text: "Memory: " + stats.memory-bytes + " bytes"; color: Theme.text-secondary; font-size: 12px; }
        Text { text: "Age: " + stats.age-steps + " steps"; color: Theme.text-secondary; font-size: 12px; }
    }
}

// ═══════════════════════════════════════════════════════════════════════════
// Main Window
// ═══════════════════════════════════════════════════════════════════════════

export component MainWindow inherits Window {
    title: "Braine Visualizer - Spot Game";
    width: 800px;
    height: 700px;
    background: Theme.bg-dark;
    
    // State from Rust
    in property <HudData> hud;
    in property <GameState> game;
    in property <BrainStats> brain-stats;
    in property <[UnitPoint]> unit-points;
    in property <[ActionScore]> action-scores;
    in property <MeaningData> meaning;
    in property <[MeaningHistDot]> meaning-pair-gap-dots;
    in property <[MeaningHistDot]> meaning-global-gap-dots;
    in-out property <LearningState> learning;
    
    // Control state
    in-out property <bool> is-braine-mode: true;
    in-out property <bool> paused: false;
    in-out property <bool> running: false;  // Whether game loop is active
    
    // Callbacks to Rust
    callback mode-changed(bool);
    callback running-changed(bool);  // New callback for start/stop
    callback trigger-dream();
    callback trigger-burst();
    callback trigger-sync();
    callback trigger-imprint();
    callback save-brain();
    callback load-brain();
    callback reset-brain();
    callback human-key-pressed(string);
    callback human-key-released(string);
    callback set-framerate(int);
    callback set-trial-period-ms(int);
    
    // Control state
    in-out property <int> framerate: 60;
    in-out property <int> trial-period-ms: 250;
    
    // Keyboard input
    in-out property <bool> human-left-pressed: false;
    in-out property <bool> human-right-pressed: false;
    
    FocusScope {
        capture-key-pressed(event) => {
            if (event.text == "a" || event.text == "A" || event.text == "ArrowLeft" || event.text == "Left" || event.text == "←") {
                root.human-left-pressed = true;
                root.human-key-pressed("left");
                return accept;
            }
            if (event.text == "d" || event.text == "D" || event.text == "ArrowRight" || event.text == "Right" || event.text == "→") {
                root.human-right-pressed = true;
                root.human-key-pressed("right");
                return accept;
            }
            return reject;
        }
        
        capture-key-released(event) => {
            if (event.text == "a" || event.text == "A" || event.text == "ArrowLeft" || event.text == "Left" || event.text == "←") {
                root.human-left-pressed = false;
                root.human-key-released("left");
                return accept;
            }
            if (event.text == "d" || event.text == "D" || event.text == "ArrowRight" || event.text == "Right" || event.text == "→") {
                root.human-right-pressed = false;
                root.human-key-released("right");
                return accept;
            }
            return reject;
        }
    
        VerticalBox {
            padding: 8px;
            spacing: 8px;
            
            // Top toolbar
            HorizontalBox {
                spacing: 8px;
                height: 36px;
                
                // Start/Stop button
                Button {
                    text: running ? "⏹ Stop" : "▶ Start";
                    clicked => {
                        running = !running;
                        running-changed(running);
                    }
                }
                
                Text { text: "Mode:"; color: Theme.text-secondary; vertical-alignment: center; }
                Button {
                    text: is-braine-mode ? "Braine" : "Human";
                    clicked => {
                        is-braine-mode = !is-braine-mode;
                        mode-changed(is-braine-mode);
                    }
                }
                
                Rectangle { horizontal-stretch: 1; }
                
                Button {
                    text: paused ? "▶ Resume" : "⏸ Pause";
                    clicked => { paused = !paused; }
                    enabled: running;  // Only enable when running
                }
            }
            
            // Main content
            HorizontalBox {
                spacing: 8px;
                
                // Left: Game canvas
                VerticalBox {
                    width: 420px;
                    spacing: 8px;
                    
                    SpotCanvas {
                        game: root.game;
                        vertical-stretch: 1;
                    }
                    
                    HudPanel {
                        hud: root.hud;
                        height: 160px;
                    }
                }
                
                // Right: Control panels
                TabWidget {
                    horizontal-stretch: 1;
                    
                    Tab {
                        title: "Learning";
                        LearningPanel {
                            state <=> learning;
                            framerate <=> root.framerate;
                            trial-period-ms <=> root.trial-period-ms;
                            trigger-dream => { root.trigger-dream(); }
                            trigger-burst => { root.trigger-burst(); }
                            trigger-sync => { root.trigger-sync(); }
                            trigger-imprint => { root.trigger-imprint(); }
                            set-framerate(fps) => { root.set-framerate(fps); }
                            set-trial-period-ms(ms) => { root.set-trial-period-ms(ms); }
                        }
                    }
                    
                    Tab {
                        title: "Brain";
                        BrainPanel {
                            stats: brain-stats;
                        }
                    }
                    
                    Tab {
                        title: "Storage";
                        Rectangle {
                            background: Theme.bg-panel;
                            VerticalBox {
                                padding: 12px;
                                spacing: 8px;
                                
                                Text {
                                    text: "Brain Persistence";
                                    color: Theme.text-primary;
                                    font-size: 14px;
                                    font-weight: 600;
                                }
                                
                                HorizontalBox {
                                    spacing: 8px;
                                    Button { text: "Save"; clicked => { save-brain(); } }
                                    Button { text: "Load"; clicked => { load-brain(); } }
                                    Button { text: "Reset"; clicked => { reset-brain(); } }
                                }
                            }
                        }
                    }

                    Tab {
                        title: "Brain Plot";
                        Rectangle {
                            background: Theme.bg-panel;
                            VerticalBox {
                                padding: 12px;
                                spacing: 8px;

                                Text {
                                    text: "Units (sampled): amp vs age";
                                    color: Theme.text-primary;
                                    font-size: 14px;
                                    font-weight: 600;
                                }

                                Rectangle {
                                    height: 260px;
                                    horizontal-stretch: 1;
                                    background: Theme.bg-dark;
                                    border-width: 1px;
                                    border-color: Theme.border;

                                    for p in unit-points: Rectangle {
                                        width: 6px;
                                        height: 6px;
                                        x: p.rel_age * (parent.width - self.width);
                                        y: (1.0 - p.amp01) * (parent.height - self.height);
                                        background: p.is_reserved ? Theme.text-secondary : (p.is_sensor_member ? Theme.accent-blue : (p.is_group_member ? Theme.accent-green : Theme.accent-yellow));
                                    }
                                }

                                Text {
                                    text: "Legend: reserved, sensor, group, other";
                                    color: Theme.text-secondary;
                                    font-size: 12px;
                                }

                                Rectangle { height: 1px; background: Theme.border; }

                                Text {
                                    text: "Action preference (habit vs meaning)";
                                    color: Theme.text-primary;
                                    font-size: 13px;
                                    font-weight: 600;
                                }

                                for s in action-scores: Text {
                                    text: s.name +
                                          "  habit=" + round(s.habit_norm * 1000) / 1000 +
                                          "  meaning=" + round(s.meaning * 1000) / 1000 +
                                          " (cond=" + round(s.meaning_conditional * 1000) / 1000 +
                                          " global=" + round(s.meaning_global * 1000) / 1000 +
                                          ")  score=" + round(s.score * 1000) / 1000;
                                    color: Theme.text-secondary;
                                    font-size: 12px;
                                }
                            }
                        }
                    }

                    Tab {
                        title: "Meaning";
                        Rectangle {
                            background: Theme.bg-panel;
                            VerticalBox {
                                padding: 12px;
                                spacing: 8px;

                                Text {
                                    text: "Meaning evidence (reward edges)";
                                    color: Theme.text-primary;
                                    font-size: 14px;
                                    font-weight: 600;
                                }

                                Text {
                                    text: "Stimulus: " + meaning.stimulus + "   correct: " + meaning.correct-action;
                                    color: Theme.text-secondary;
                                    font-size: 12px;
                                }

                                Text {
                                    text: "pair(stim, left)  +" + round(meaning.pair-left.to-reward-pos * 1000) / 1000 +
                                          "  -" + round(meaning.pair-left.to-reward-neg * 1000) / 1000 +
                                          "  meaning=" + round(meaning.pair-left.meaning * 1000) / 1000;
                                    color: Theme.text-secondary;
                                    font-size: 12px;
                                }
                                Text {
                                    text: "pair(stim, right) +" + round(meaning.pair-right.to-reward-pos * 1000) / 1000 +
                                          "  -" + round(meaning.pair-right.to-reward-neg * 1000) / 1000 +
                                          "  meaning=" + round(meaning.pair-right.meaning * 1000) / 1000;
                                    color: Theme.text-secondary;
                                    font-size: 12px;
                                }

                                Rectangle { height: 1px; background: Theme.border; }

                                Text {
                                    text: "action(left)      +" + round(meaning.action-left.to-reward-pos * 1000) / 1000 +
                                          "  -" + round(meaning.action-left.to-reward-neg * 1000) / 1000 +
                                          "  meaning=" + round(meaning.action-left.meaning * 1000) / 1000;
                                    color: Theme.text-secondary;
                                    font-size: 12px;
                                }
                                Text {
                                    text: "action(right)     +" + round(meaning.action-right.to-reward-pos * 1000) / 1000 +
                                          "  -" + round(meaning.action-right.to-reward-neg * 1000) / 1000 +
                                          "  meaning=" + round(meaning.action-right.meaning * 1000) / 1000;
                                    color: Theme.text-secondary;
                                    font-size: 12px;
                                }

                                Rectangle { height: 1px; background: Theme.border; }

                                Text {
                                    text: "Gaps (correct - wrong): pair=" + round(meaning.pair-gap * 1000) / 1000 + "   global=" + round(meaning.global-gap * 1000) / 1000;
                                    color: Theme.text-secondary;
                                    font-size: 12px;
                                }

                                Text { text: "Pair gap history"; color: Theme.text-primary; font-size: 13px; font-weight: 600; }
                                Rectangle {
                                    height: 110px;
                                    horizontal-stretch: 1;
                                    background: Theme.bg-dark;
                                    border-width: 1px;
                                    border-color: Theme.border;

                                    Rectangle { x: 0px; y: parent.height / 2; width: parent.width; height: 1px; background: Theme.border; }

                                    for d in meaning-pair-gap-dots: Rectangle {
                                        width: 5px;
                                        height: 5px;
                                        x: d.x01 * (parent.width - self.width);
                                        y: (0.5 - 0.45 * d.v) * (parent.height - self.height);
                                        background: d.positive ? Theme.accent-green : Theme.accent-red;
                                    }
                                }

                                Text { text: "Global gap history"; color: Theme.text-primary; font-size: 13px; font-weight: 600; }
                                Rectangle {
                                    height: 110px;
                                    horizontal-stretch: 1;
                                    background: Theme.bg-dark;
                                    border-width: 1px;
                                    border-color: Theme.border;

                                    Rectangle { x: 0px; y: parent.height / 2; width: parent.width; height: 1px; background: Theme.border; }

                                    for d in meaning-global-gap-dots: Rectangle {
                                        width: 5px;
                                        height: 5px;
                                        x: d.x01 * (parent.width - self.width);
                                        y: (0.5 - 0.45 * d.v) * (parent.height - self.height);
                                        background: d.positive ? Theme.accent-green : Theme.accent-red;
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
    }
}
