// Braine Desktop - Main Window (Modular)
// Imports components from separate files for maintainability

import { VerticalBox, HorizontalBox, Button, Slider, CheckBox, TabWidget, GroupBox, ScrollView, LineEdit, Palette } from "std-widgets.slint";

// Import modular components
import { Theme } from "theme.slint";
import { HudData, LearningState, BrainStats, UnitPoint, ActionScore, MeaningEdges, SnapshotItem, MeaningData, MeaningHistDot, GameState, GraphNodeDot, GraphEdgeSeg } from "types.slint";
import { SpotCanvas, BanditCanvas, PongCanvas, SpotXYCanvas, MazeCanvas } from "canvases.slint";
import { GameHeader, HudPanel, LearningPanel, BrainPanel } from "panels.slint";
import { AboutPanel } from "about.slint";

component TierPill inherits Rectangle {
    in property <string> label;
    in property <bool> active: false;
    in property <color> active-color: Theme.accent-blue;
    in property <bool> enabled: true;
    callback clicked();

    height: 20px;
    min-width: 42px;
    border-radius: 10px;
    background: enabled ? (active ? active-color : #ffffff12) : #ffffff08;
    border-width: 1px;
    border-color: enabled ? (active ? active-color : #ffffff33) : #ffffff1a;
    opacity: enabled ? 1.0 : 0.6;

    TouchArea {
        enabled: parent.enabled;
        clicked => { root.clicked(); }
    }

    Text {
        text: root.label;
        color: Theme.text-primary;
        font-size: 12px;
        font-weight: root.active ? 700 : 600;
        horizontal-alignment: center;
        vertical-alignment: center;
    }
}

// ═══════════════════════════════════════════════════════════════════════════
// Main Window
// ═══════════════════════════════════════════════════════════════════════════

export component MainWindow inherits Window {
    title: "Braine Visualizer";
    preferred-width: 1040px;
    preferred-height: 740px;
    min-width: 860px;
    min-height: 600px;
    background: Theme.bg-dark;

    // Ensure standard widgets (including TabWidget tab labels) use a dark palette.
    // We do this with a one-shot timer because global properties are assigned via
    // imperative `=` (not `:` bindings) in Slint.
    Timer {
        interval: 1ms;
        running: true;
        triggered => {
            Palette.color-scheme = ColorScheme.dark;
            self.stop();
        }
    }
    
    // State from Rust
    in property <HudData> hud;
    in property <GameState> game;
    in property <BrainStats> brain-stats;
    in property <[UnitPoint]> unit-points;
    in property <[float]> osc-samples;
    in property <[ActionScore]> action-scores;
    in property <MeaningData> meaning;
    in property <[MeaningHistDot]> meaning-pair-gap-dots;
    in property <[MeaningHistDot]> meaning-global-gap-dots;

    // Learning monitor history (client-side rolling buffers).
    in property <[MeaningHistDot]> learning-eligibility-dots;
    in property <[MeaningHistDot]> learning-plasticity-dots;
    in property <[MeaningHistDot]> learning-homeostasis-bias-dots;

    // Storage state from daemon
    in property <string> storage-data-dir: "";
    in property <string> storage-brain-file: "";
    in property <int> storage-brain-bytes: 0;
    in property <string> storage-runtime-file: "";
    in property <int> storage-runtime-bytes: 0;
    in property <string> storage-loaded-snapshot: "";
    in property <int> storage-state-wrapper-version: 0;
    in property <[SnapshotItem]> storage-snapshots;

    in property <[GraphNodeDot]> graph-nodes;
    in property <[GraphEdgeSeg]> graph-edge-segs;
    in property <string> graph-stats: "";
    in-out property <LearningState> learning;
    
    // Game param schema properties (set by Rust from daemon)
    in-out property <float> pong-paddle-speed-min: 0.3;
    in-out property <float> pong-paddle-speed-max: 3.0;
    in-out property <float> pong-paddle-speed-default: 1.0;
    in-out property <float> pong-ball-speed-min: 0.2;
    in-out property <float> pong-ball-speed-max: 2.0;
    in-out property <float> pong-ball-speed-default: 0.5;
    in-out property <float> pong-paddle-half-height-min: 0.10;
    in-out property <float> pong-paddle-half-height-max: 0.45;
    in-out property <float> pong-paddle-half-height-default: 0.20;
    in-out property <int> spotxy-grid-n-min: 0;
    in-out property <int> spotxy-grid-n-max: 8;
    in-out property <int> spotxy-grid-n-default: 0;
    
    // Control state
    in-out property <bool> is-braine-mode: true;
    in-out property <bool> paused: false;
    in-out property <bool> running: false;

    // System error banner (daemon-reported). Empty string means no active error.
    in-out property <string> system_error: "";

    in-out property <string> selected-game-kind: "spot";
    property <string> effective-game-kind: running ? game.kind : selected-game-kind;

    // Auto snapshot settings
    in-out property <bool> auto-snapshot-enabled: false;
    in-out property <int> auto-snapshot-interval-s: 300;

    // Experts (child brains)
    in-out property <bool> experts-enabled: false;
    in-out property <bool> experts-allow-nested: false;
    in-out property <int> experts-max-depth: 1;

    // Expert policy controls (applied explicitly)
    in-out property <string> experts-parent-learning: "holdout";
    in-out property <int> experts-max-children: 2;
    in-out property <float> experts-child-reward-scale: 1.5;
    in-out property <int> experts-episode-trials: 32;
    in-out property <int> experts-consolidate-topk: 64;
    in-out property <string> experts-persistence-mode: "full";
    in-out property <float> experts-reward-shift-ema-delta-threshold: 0.55;
    in-out property <float> experts-performance-collapse-drop-threshold: 0.65;
    in-out property <float> experts-performance-collapse-baseline-min: 0.25;

    // Storage safety
    in-out property <bool> reset-confirmed: false;

    // Replay dataset controls
    in-out property <string> replay-dataset-path: "";
    in-out property <string> replay-dataset-status: "";

    // Advisor / LLM integration (daemon-only)
    in-out property <bool> advisor-enabled: false;
    in-out property <string> advisor-mode: "";
    in-out property <int> advisor-every-trials: 0;
    in-out property <string> advisor-last-rationale: "";
    in-out property <bool> advisor-include-action-scores: false;
    in-out property <string> advisor-context-json: "";
    in-out property <string> advisor-report-json: "";
    in-out property <string> advisor-status: "";
    
    // Callbacks to Rust
    callback mode-changed(bool);
    callback running-changed(bool);
    callback game-changed(string);
    callback spotxy-eval-changed(bool);
    callback spotxy-increase-grid();
    callback spotxy-decrease-grid();
    callback trigger-dream();
    callback trigger-burst();
    callback trigger-sync();
    callback trigger-imprint();
    callback save-brain();
    callback load-brain();
    callback reset-brain();
    callback migrate-state-format(int);
    callback set-max-units(int);
    callback save-snapshot();
    callback load-snapshot(string);
    callback human-key-pressed(string);
    callback human-key-released(string);
    callback set-framerate(int);
    callback set-trial-period-ms(int);
    callback set-execution-tier(string);
    callback set-game-param(string, string, float);
    callback auto-snapshot-settings-changed(bool, int);
    callback experts-enabled-changed(bool);
    callback experts-nesting-changed(bool, int);
    callback experts-policy-apply(string, int, float, int, int, float, float, float, string, bool, int);
    callback cull-experts();
    callback graph-request(string, int, int, bool);
    callback graph-hover(float, float);
    callback view-mode-changed(string);

    callback replay-load-dataset(string);
    callback replay-load-sample();

    callback advisor-fetch-context(bool);
    callback advisor-once(bool);
    
    // Control state
    in-out property <int> framerate: 60;
    in-out property <int> trial-period-ms: 250;

    // Graph controls
    in-out property <string> graph-kind: "substrate";
    in-out property <string> graph-layout: "force";
    in-out property <int> graph-max-nodes: 1000;
    in-out property <int> graph-max-edges: 50000;
    in-out property <bool> graph-include-isolated: false;
    in-out property <bool> graph-auto-refresh: false;
    in-out property <int> graph-interval-ms: 1000;
    in-out property <float> graph-zoom: 1.0;
    in-out property <float> graph-pan-x01: 0.0;
    in-out property <float> graph-pan-y01: 0.0;

    // Graph hover tooltip
    in-out property <bool> graph-hover-visible: false;
    in-out property <float> graph-hover-x01: 0.0;
    in-out property <float> graph-hover-y01: 0.0;
    in-out property <string> graph-hover-text: "";

    in property <string> experts-status: "";
    in-out property <string> view-mode: "parent";
    
    // Keyboard input
    in-out property <bool> human-left-pressed: false;
    in-out property <bool> human-right-pressed: false;
    in-out property <bool> human-up-pressed: false;
    in-out property <bool> human-down-pressed: false;
    
    FocusScope {
        capture-key-pressed(event) => {
            if (root.effective-game-kind == "pong") {
                if (event.text == "w" || event.text == "W" || event.text == "ArrowUp" || event.text == "Up" || event.text == "↑") {
                    root.human-up-pressed = true;
                    root.human-key-pressed("up");
                    return accept;
                }
                if (event.text == "s" || event.text == "S" || event.text == "ArrowDown" || event.text == "Down" || event.text == "↓") {
                    root.human-down-pressed = true;
                    root.human-key-pressed("down");
                    return accept;
                }
                if (event.text == " " || event.text == "Space") {
                    root.human-key-pressed("stay");
                    return accept;
                }
                return reject;
            }

            if (root.effective-game-kind == "maze") {
                if (event.text == "w" || event.text == "W" || event.text == "ArrowUp" || event.text == "Up" || event.text == "↑") {
                    root.human-up-pressed = true;
                    root.human-key-pressed("up");
                    return accept;
                }
                if (event.text == "s" || event.text == "S" || event.text == "ArrowDown" || event.text == "Down" || event.text == "↓") {
                    root.human-down-pressed = true;
                    root.human-key-pressed("down");
                    return accept;
                }
                if (event.text == "a" || event.text == "A" || event.text == "ArrowLeft" || event.text == "Left" || event.text == "←") {
                    root.human-left-pressed = true;
                    root.human-key-pressed("left");
                    return accept;
                }
                if (event.text == "d" || event.text == "D" || event.text == "ArrowRight" || event.text == "Right" || event.text == "→") {
                    root.human-right-pressed = true;
                    root.human-key-pressed("right");
                    return accept;
                }
                return reject;
            }

            if (event.text == "a" || event.text == "A" || event.text == "ArrowLeft" || event.text == "Left" || event.text == "←") {
                root.human-left-pressed = true;
                root.human-key-pressed("left");
                return accept;
            }
            if (event.text == "d" || event.text == "D" || event.text == "ArrowRight" || event.text == "Right" || event.text == "→") {
                root.human-right-pressed = true;
                root.human-key-pressed("right");
                return accept;
            }
            return reject;
        }
        
        capture-key-released(event) => {
            if (root.effective-game-kind == "pong") {
                if (event.text == "w" || event.text == "W" || event.text == "ArrowUp" || event.text == "Up" || event.text == "↑") {
                    root.human-up-pressed = false;
                    root.human-key-released("up");
                    return accept;
                }
                if (event.text == "s" || event.text == "S" || event.text == "ArrowDown" || event.text == "Down" || event.text == "↓") {
                    root.human-down-pressed = false;
                    root.human-key-released("down");
                    return accept;
                }
                if (event.text == " " || event.text == "Space") {
                    root.human-key-released("stay");
                    return accept;
                }
                return reject;
            }

            if (root.effective-game-kind == "maze") {
                if (event.text == "w" || event.text == "W" || event.text == "ArrowUp" || event.text == "Up" || event.text == "↑") {
                    root.human-up-pressed = false;
                    root.human-key-released("up");
                    return accept;
                }
                if (event.text == "s" || event.text == "S" || event.text == "ArrowDown" || event.text == "Down" || event.text == "↓") {
                    root.human-down-pressed = false;
                    root.human-key-released("down");
                    return accept;
                }
                if (event.text == "a" || event.text == "A" || event.text == "ArrowLeft" || event.text == "Left" || event.text == "←") {
                    root.human-left-pressed = false;
                    root.human-key-released("left");
                    return accept;
                }
                if (event.text == "d" || event.text == "D" || event.text == "ArrowRight" || event.text == "Right" || event.text == "→") {
                    root.human-right-pressed = false;
                    root.human-key-released("right");
                    return accept;
                }
                return reject;
            }

            if (event.text == "a" || event.text == "A" || event.text == "ArrowLeft" || event.text == "Left" || event.text == "←") {
                root.human-left-pressed = false;
                root.human-key-released("left");
                return accept;
            }
            if (event.text == "d" || event.text == "D" || event.text == "ArrowRight" || event.text == "Right" || event.text == "→") {
                root.human-right-pressed = false;
                root.human-key-released("right");
                return accept;
            }
            return reject;
        }
    
        VerticalBox {
            padding: 8px;
            spacing: 8px;
            
            // Top toolbar
            HorizontalBox {
                spacing: 8px;
                height: 36px;
                
                Button {
                    text: running ? "⏹ Stop" : "▶ Start";
                    clicked => {
                        running = !running;
                        running-changed(running);
                    }
                }

                Text { text: "Game:"; color: Theme.text-secondary; vertical-alignment: center; }
                Button {
                    text: (root.effective-game-kind == "bandit") ? "Bandit" :
                          (root.effective-game-kind == "spot_reversal") ? "Spot Reversal" :
                          (root.effective-game-kind == "spotxy") ? "SpotXY" :
                          (root.effective-game-kind == "maze") ? "Maze" :
                          (root.effective-game-kind == "pong") ? "Pong" :
                          (root.effective-game-kind == "text") ? "Text" :
                          (root.effective-game-kind == "replay") ? "Replay" :
                          "Spot";
                    enabled: !running;
                    clicked => {
                        root.selected-game-kind = (root.selected-game-kind == "spot") ? "bandit" :
                                                  (root.selected-game-kind == "bandit") ? "spot_reversal" :
                                                  (root.selected-game-kind == "spot_reversal") ? "spotxy" :
                                                  (root.selected-game-kind == "spotxy") ? "maze" :
                                                  (root.selected-game-kind == "maze") ? "pong" :
                                                  (root.selected-game-kind == "pong") ? "text" :
                                                  (root.selected-game-kind == "text") ? "replay" :
                                                  "spot";

                        // Pong is sensitive to control cadence. If the user hasn't already chosen
                        // a relatively fast trial period, switch to a more controllable default.
                        if (root.selected-game-kind == "pong" && root.trial-period-ms > 200) {
                            root.trial-period-ms = 100;
                            root.set-trial-period-ms(100);
                        }

                        if (root.selected-game-kind == "maze" && root.trial-period-ms > 200) {
                            root.trial-period-ms = 90;
                            root.set-trial-period-ms(90);
                        }

                        game-changed(root.selected-game-kind);
                    }
                }
                
                Rectangle { horizontal-stretch: 1; }

                if root.experts-status != "": Button {
                    text: (root.view-mode == "active_expert") ? "View: Active Expert" : "View: Parent";
                    clicked => {
                        root.view-mode = (root.view-mode == "active_expert") ? "parent" : "active_expert";
                        root.view-mode-changed(root.view-mode);
                    }
                }

                // Prevent long status strings from pushing controls past the right edge.
                if root.experts-status != "": Rectangle {
                    width: 260px;
                    height: 20px;
                    clip: true;
                    background: transparent;

                    Text {
                        width: parent.width;
                        height: parent.height;
                        text: root.experts-status;
                        color: Theme.text-secondary;
                        vertical-alignment: center;
                        horizontal-alignment: left;
                        font-size: 12px;
                    }
                }

                if root.brain-stats.execution-tier != "": Rectangle {
                    height: 22px;
                    border-radius: 11px;
                    background: #4080aa20;
                    border-width: 1px;
                    border-color: #4080aa66;

                    HorizontalBox {
                        padding-left: 8px;
                        padding-right: 6px;
                        spacing: 6px;

                        Text {
                            text: (root.brain-stats.execution-tier-selected != "" && root.brain-stats.execution-tier-effective != "") ?
                                  ("Tier: sel=" + root.brain-stats.execution-tier-selected + " eff=" + root.brain-stats.execution-tier-effective) :
                                  ("Tier: " + root.brain-stats.execution-tier);
                            color: Theme.text-primary;
                            vertical-alignment: center;
                            font-size: 12px;
                        }

                        Rectangle { horizontal-stretch: 1; background: transparent; }

                        TierPill {
                            label: "CPU";
                            active:
                                (root.brain-stats.execution-tier-selected == "scalar" || root.brain-stats.execution-tier-selected == "Scalar") ||
                                (root.brain-stats.execution-tier-selected == "" && (root.brain-stats.execution-tier == "scalar" || root.brain-stats.execution-tier == "Scalar"));
                            active-color: Theme.accent-blue;
                            clicked => { root.set-execution-tier("scalar"); }
                        }
                        TierPill {
                            label: "GPU";
                            active:
                                (root.brain-stats.execution-tier-selected == "gpu" || root.brain-stats.execution-tier-selected == "Gpu") ||
                                (root.brain-stats.execution-tier-selected == "" && (root.brain-stats.execution-tier == "gpu" || root.brain-stats.execution-tier == "Gpu"));
                            active-color: Theme.accent-green;
                            clicked => { root.set-execution-tier("gpu"); }
                        }
                    }
                }
                
                Button {
                    text: paused ? "▶ Resume UI" : "⏸ Pause UI";
                    clicked => { paused = !paused; }
                    enabled: running;
                }
            }
            
            // Main content
            HorizontalBox {
                spacing: 8px;
                vertical-stretch: 1;
                
                // Left: Game canvas
                VerticalBox {
                    horizontal-stretch: 1;
                    min-width: 320px;
                    spacing: 8px;
                    vertical-stretch: 1;

                    if root.system_error != "": Rectangle {
                        background: #ff3b3018;
                        border-color: #ff3b3055;
                        border-width: 1px;
                        border-radius: 8px;
                        preferred-height: 58px;

                        HorizontalBox {
                            padding: 10px;
                            spacing: 10px;

                            VerticalBox {
                                spacing: 2px;
                                Text {
                                    text: "Error";
                                    color: #ffb4ad;
                                    font-size: 12px;
                                    font-weight: 700;
                                }
                                Text {
                                    text: root.system_error;
                                    color: Theme.text-primary;
                                    font-size: 12px;
                                    wrap: word-wrap;
                                }
                            }

                            Rectangle { horizontal-stretch: 1; background: transparent; }

                            Button {
                                text: "Dismiss";
                                clicked => { root.system_error = ""; }
                            }
                        }
                    }

                    GameHeader {
                        kind: root.effective-game-kind;
                        game: root.game;
                    }

                    if root.effective-game-kind == "spotxy": SpotXYCanvas {
                        game: root.game;
                        frame: root.hud.frame;
                        vertical-stretch: 1;
                    }
                    if root.effective-game-kind == "maze": MazeCanvas {
                        game: root.game;
                        vertical-stretch: 1;
                    }
                    if root.effective-game-kind == "pong": PongCanvas {
                        game: root.game;
                        vertical-stretch: 1;
                    }
                    if root.effective-game-kind == "bandit": BanditCanvas {
                        game: root.game;
                        vertical-stretch: 1;
                    }
                    if root.effective-game-kind != "spotxy" && root.effective-game-kind != "maze" && root.effective-game-kind != "pong" && root.effective-game-kind != "bandit": SpotCanvas {
                        game: root.game;
                        vertical-stretch: 1;
                    }
                    
                    HudPanel {
                        hud: root.hud;
                        trial-ms: root.game.trial-duration;
                        preferred-height: 160px;
                        min-height: 120px;
                    }
                }
                
                // Right: Control panels (tabs)
                TabWidget {
                    horizontal-stretch: 2;
                    vertical-stretch: 1;
                    
                    Tab {
                        title: "Learning";
                        ScrollView {
                            horizontal-stretch: 1;
                            vertical-stretch: 1;
                            LearningPanel {
                                state <=> learning;
                                framerate <=> root.framerate;
                                trial-period-ms <=> root.trial-period-ms;
                                trigger-dream => { root.trigger-dream(); }
                                trigger-burst => { root.trigger-burst(); }
                                trigger-sync => { root.trigger-sync(); }
                                trigger-imprint => { root.trigger-imprint(); }
                                set-framerate(fps) => { root.set-framerate(fps); }
                                set-trial-period-ms(ms) => { root.set-trial-period-ms(ms); }
                            }
                        }
                    }

                    Tab {
                        title: "Game Settings";
                        ScrollView {
                            horizontal-stretch: 1;
                            vertical-stretch: 1;
                            Rectangle {
                                background: Theme.bg-panel;
                                horizontal-stretch: 1;
                                VerticalBox {
                                    padding: 12px;
                                    spacing: 10px;

                                    if root.effective-game-kind == "pong": Text {
                                        text: "Pong";
                                        color: Theme.text-primary;
                                        font-size: 14px;
                                        font-weight: 600;
                                    }

                                    if root.effective-game-kind == "pong": Text {
                                        text: "Keys: W/Up = up, S/Down = down, Space = stay";
                                        color: Theme.text-secondary;
                                        font-size: 12px;
                                    }

                                    if root.effective-game-kind == "pong": VerticalBox {
                                        spacing: 8px;

                                        HorizontalBox {
                                            spacing: 10px;
                                            Text { text: "Hits:"; color: Theme.text-secondary; font-size: 12px; vertical-alignment: center; }
                                            Text { text: "" + root.game.pong-hits; color: Theme.text-primary; font-size: 12px; vertical-alignment: center; }
                                            Rectangle { width: 10px; height: 1px; background: transparent; }
                                            Text { text: "Misses:"; color: Theme.text-secondary; font-size: 12px; vertical-alignment: center; }
                                            Text { text: "" + root.game.pong-misses; color: Theme.text-primary; font-size: 12px; vertical-alignment: center; }
                                        }

                                        HorizontalBox {
                                            spacing: 8px;
                                            Text { text: "Paddle speed:"; color: Theme.text-secondary; vertical-alignment: center; font-size: 12px; }
                                            Slider {
                                                width: 220px;
                                                minimum: 0.3;
                                                maximum: 3.0;
                                                value: root.game.pong-paddle-speed;
                                                changed => { set-game-param("pong", "paddle_speed", self.value); }
                                            }
                                            Text { text: "" + (round(root.game.pong-paddle-speed * 1000.0) / 1000.0); color: Theme.text-secondary; vertical-alignment: center; font-size: 12px; }
                                        }

                                        HorizontalBox {
                                            spacing: 8px;
                                            Text { text: "Ball speed:"; color: Theme.text-secondary; vertical-alignment: center; font-size: 12px; }
                                            Slider {
                                                width: 220px;
                                                minimum: 0.2;
                                                maximum: 2.0;
                                                value: root.game.pong-ball-speed;
                                                changed => { set-game-param("pong", "ball_speed", self.value); }
                                            }
                                            Text { text: "" + (round(root.game.pong-ball-speed * 1000.0) / 1000.0); color: Theme.text-secondary; vertical-alignment: center; font-size: 12px; }
                                        }

                                        HorizontalBox {
                                            spacing: 8px;
                                            Text { text: "Paddle height:"; color: Theme.text-secondary; vertical-alignment: center; font-size: 12px; }
                                            Slider {
                                                width: 220px;
                                                minimum: 0.10;
                                                maximum: 0.45;
                                                value: root.game.pong-paddle-half-height;
                                                changed => { set-game-param("pong", "paddle_half_height", self.value); }
                                            }
                                            Text { text: "" + (round(root.game.pong-paddle-half-height * 100.0) / 100.0); color: Theme.text-secondary; vertical-alignment: center; font-size: 12px; }
                                        }

                                        CheckBox {
                                            text: "Distractor ball (2 balls)";
                                            checked: root.game.pong-ball2-enabled;
                                            toggled => { set-game-param("pong", "distractor_enabled", self.checked ? 1.0 : 0.0); }
                                        }
                                    }

                                    if root.effective-game-kind == "bandit": Text {
                                        text: "Bandit: Choose an arm; rewards are stochastic.";
                                        color: Theme.text-secondary;
                                        font-size: 12px;
                                        wrap: word-wrap;
                                    }

                                    if root.effective-game-kind == "spotxy": Text {
                                        text: (root.game.spotxy-grid-n > 0) ?
                                            "SpotXY (" + root.game.spotxy-grid-n + "×" + root.game.spotxy-grid-n + " grid)" :
                                            "SpotXY (2 actions)";
                                        color: Theme.text-primary;
                                        font-size: 14px;
                                        font-weight: 600;
                                    }

                                    if root.effective-game-kind == "spotxy": CheckBox {
                                        text: "Eval (held-out, no learning)";
                                        enabled: root.game.kind == "spotxy";
                                        checked: root.game.spotxy-eval;
                                        toggled => { spotxy-eval-changed(self.checked); }
                                    }

                                    if root.effective-game-kind == "spotxy": HorizontalBox {
                                        spacing: 8px;
                                        Text { text: "Grid:"; color: Theme.text-secondary; vertical-alignment: center; font-size: 12px; }
                                        Button {
                                            text: "+";
                                            enabled: root.game.kind == "spotxy" && !root.game.spotxy-eval && root.hud.mastered-at-trial >= 0;
                                            clicked => { spotxy-increase-grid(); }
                                        }
                                        Text {
                                            text: (root.game.spotxy-grid-n > 0) ?
                                                  (root.game.spotxy-grid-n + "×" + root.game.spotxy-grid-n) :
                                                  "2 actions";
                                            color: Theme.text-secondary;
                                            vertical-alignment: center;
                                            font-size: 12px;
                                        }
                                        Button {
                                            text: "-";
                                            enabled: root.game.kind == "spotxy" && !root.game.spotxy-eval && root.game.spotxy-grid-n > 0;
                                            clicked => { spotxy-decrease-grid(); }
                                        }
                                    }

                                    if root.effective-game-kind == "replay": VerticalBox {
                                        spacing: 8px;

                                        Text {
                                            text: "Replay Dataset";
                                            color: Theme.text-primary;
                                            font-size: 14px;
                                            font-weight: 600;
                                        }

                                        Text {
                                            text: "Stop the simulation before loading a dataset.";
                                            color: Theme.text-secondary;
                                            font-size: 12px;
                                            wrap: word-wrap;
                                        }

                                        LineEdit {
                                            text <=> root.replay-dataset-path;
                                            enabled: !root.running;
                                        }

                                        HorizontalBox {
                                            spacing: 8px;
                                            Button {
                                                text: "Load from path";
                                                enabled: !root.running;
                                                clicked => { root.replay-load-dataset(root.replay-dataset-path); }
                                            }
                                            Button {
                                                text: "Load sample";
                                                enabled: !root.running;
                                                clicked => { root.replay-load-sample(); }
                                            }
                                        }

                                        if root.replay-dataset-status != "": Text {
                                            text: root.replay-dataset-status;
                                            color: Theme.text-secondary;
                                            font-size: 12px;
                                            wrap: word-wrap;
                                        }
                                    }

                                    if root.effective-game-kind != "spotxy" && root.effective-game-kind != "pong" && root.effective-game-kind != "bandit": Text {
                                        text: "No game-specific settings yet.";
                                        color: Theme.text-secondary;
                                        font-size: 12px;
                                    }
                                }
                            }
                        }
                    }
                    
                    Tab {
                        title: "Brain";
                        ScrollView {
                            horizontal-stretch: 1;
                            vertical-stretch: 1;
                            BrainPanel {
                                stats: brain-stats;
                                learning-eligibility-dots: learning-eligibility-dots;
                                learning-plasticity-dots: learning-plasticity-dots;
                                learning-homeostasis-bias-dots: learning-homeostasis-bias-dots;
                                experts-status: root.experts-status;
                                set-max-units(n) => { root.set-max-units(n); }
                                experts-enabled: root.experts-enabled;
                                experts-enabled-changed(v) => { root.experts-enabled = v; root.experts-enabled-changed(v); }
                                experts-allow-nested: root.experts-allow-nested;
                                experts-max-depth: root.experts-max-depth;
                                experts-nesting-changed(allow_nested, max_depth) => {
                                    root.experts-allow-nested = allow_nested;
                                    root.experts-max-depth = max_depth;
                                    root.experts-nesting-changed(allow_nested, max_depth);
                                }

                                experts-parent-learning <=> root.experts-parent-learning;
                                experts-max-children <=> root.experts-max-children;
                                experts-child-reward-scale <=> root.experts-child-reward-scale;
                                experts-episode-trials <=> root.experts-episode-trials;
                                experts-consolidate-topk <=> root.experts-consolidate-topk;
                                experts-persistence-mode <=> root.experts-persistence-mode;
                                experts-reward-shift-ema-delta-threshold <=> root.experts-reward-shift-ema-delta-threshold;
                                experts-performance-collapse-drop-threshold <=> root.experts-performance-collapse-drop-threshold;
                                experts-performance-collapse-baseline-min <=> root.experts-performance-collapse-baseline-min;
                                experts-policy-apply(parent_learning, max_children, child_reward_scale, episode_trials, consolidate_topk, reward_shift_ema_delta_threshold, performance_collapse_drop_threshold, performance_collapse_baseline_min, persistence_mode, allow_nested, max_depth) => {
                                    root.experts-policy-apply(parent_learning, max_children, child_reward_scale, episode_trials, consolidate_topk, reward_shift_ema_delta_threshold, performance_collapse_drop_threshold, performance_collapse_baseline_min, persistence_mode, allow_nested, max_depth);
                                }
                                cull-experts => { root.cull-experts(); }
                            }
                        }
                    }
                    
                    Tab {
                        title: "Storage";
                        ScrollView {
                            horizontal-stretch: 1;
                            vertical-stretch: 1;
                            Rectangle {
                                background: Theme.bg-panel;
                                horizontal-stretch: 1;
                                VerticalBox {
                                    padding: 12px;
                                    spacing: 8px;
                                
                                    Text {
                                        text: "Brain Persistence";
                                        color: Theme.text-primary;
                                        font-size: 14px;
                                        font-weight: 600;
                                    }

                                    Text {
                                        text: "Data dir: " + root.storage-data-dir;
                                        color: Theme.text-secondary;
                                        font-size: 12px;
                                    }

                                    if root.storage-loaded-snapshot != "": Text {
                                        text: "Loaded snapshot: " + root.storage-loaded-snapshot;
                                        color: Theme.text-secondary;
                                        font-size: 12px;
                                    }

                                    Text {
                                        text: "Current brain: " + root.storage-brain-bytes + " bytes";
                                        color: Theme.text-secondary;
                                        font-size: 12px;
                                    }

                                    Text {
                                        text: "State format (daemon wrapper): v" + root.storage-state-wrapper-version;
                                        color: Theme.text-secondary;
                                        font-size: 12px;
                                    }

                                    HorizontalBox {
                                        spacing: 8px;
                                        Button { text: "Save snapshot"; clicked => { save-snapshot(); } }
                                        CheckBox {
                                            text: "Auto";
                                            checked: root.auto-snapshot-enabled;
                                            toggled => {
                                                root.auto-snapshot-enabled = self.checked;
                                                auto-snapshot-settings-changed(root.auto-snapshot-enabled, root.auto-snapshot-interval-s);
                                            }
                                        }
                                        Text { text: "Interval (s):"; color: Theme.text-secondary; vertical-alignment: center; font-size: 12px; }
                                        Button {
                                            text: "-";
                                            clicked => {
                                                root.auto-snapshot-interval-s = max(10, root.auto-snapshot-interval-s - 60);
                                                auto-snapshot-settings-changed(root.auto-snapshot-enabled, root.auto-snapshot-interval-s);
                                            }
                                        }
                                        Text { text: root.auto-snapshot-interval-s; color: Theme.text-secondary; vertical-alignment: center; font-size: 12px; }
                                        Button {
                                            text: "+";
                                            clicked => {
                                                root.auto-snapshot-interval-s = min(86400, root.auto-snapshot-interval-s + 60);
                                                auto-snapshot-settings-changed(root.auto-snapshot-enabled, root.auto-snapshot-interval-s);
                                            }
                                        }
                                    }

                                    HorizontalBox {
                                        spacing: 8px;
                                        Button { text: "Save brain"; clicked => { save-brain(); } }
                                        Button { text: "Load brain"; clicked => { load-brain(); } }
                                        Button {
                                            text: "Migrate to v2";
                                            enabled: !root.running && root.storage-state-wrapper-version != 2;
                                            clicked => { migrate-state-format(2); }
                                        }
                                        CheckBox {
                                            text: "Enable reset";
                                            checked: root.reset-confirmed;
                                            toggled => { root.reset-confirmed = self.checked; }
                                        }
                                        Button {
                                            text: "Reset brain";
                                            enabled: root.reset-confirmed;
                                            clicked => { reset-brain(); root.reset-confirmed = false; }
                                        }
                                    }

                                    Rectangle { height: 1px; background: Theme.border; }

                                    Text {
                                        text: "Snapshots";
                                        color: Theme.text-primary;
                                        font-size: 13px;
                                        font-weight: 600;
                                    }

                                    if root.storage-snapshots.length == 0: Text {
                                        text: "No snapshots yet.";
                                        color: Theme.text-secondary;
                                        font-size: 12px;
                                    }

                                    for s in root.storage-snapshots: HorizontalBox {
                                        spacing: 8px;
                                        Text {
                                            text: s.stem + " (" + s.brain-bytes + "b)";
                                            color: Theme.text-secondary;
                                            font-size: 12px;
                                            horizontal-stretch: 1;
                                        }
                                        Button {
                                            text: "Load";
                                            clicked => { load-snapshot(s.stem); }
                                        }
                                    }
                                }
                            }
                        }
                    }

                    Tab {
                        title: "Advisor";
                        ScrollView {
                            horizontal-stretch: 1;
                            vertical-stretch: 1;
                            Rectangle {
                                background: Theme.bg-panel;
                                horizontal-stretch: 1;
                                VerticalBox {
                                    padding: 12px;
                                    spacing: 8px;

                                    Text {
                                        text: "LLM Integration (Advisor)";
                                        color: Theme.text-primary;
                                        font-size: 14px;
                                        font-weight: 600;
                                    }

                                    Text {
                                        text: "This is a bounded, slow-loop integration point: Braine produces structured context; an external LLM returns bounded advice. The LLM does not select actions.";
                                        color: Theme.text-secondary;
                                        font-size: 12px;
                                        wrap: word-wrap;
                                    }

                                    Text {
                                        text: "status=" + (root.advisor-enabled ? "on" : "off") + " mode=" + root.advisor-mode + " every_trials=" + root.advisor-every-trials;
                                        color: Theme.text-secondary;
                                        font-size: 12px;
                                        wrap: word-wrap;
                                    }

                                    if root.advisor-last-rationale != "": Text {
                                        text: "last_rationale=" + root.advisor-last-rationale;
                                        color: Theme.text-secondary;
                                        font-size: 12px;
                                        wrap: word-wrap;
                                    }

                                    Rectangle { height: 1px; background: Theme.border; }

                                    CheckBox {
                                        text: "Include action score breakdowns";
                                        checked: root.advisor-include-action-scores;
                                        toggled => { root.advisor-include-action-scores = self.checked; }
                                    }

                                    HorizontalBox {
                                        spacing: 8px;
                                        Button {
                                            text: "Get context";
                                            clicked => { root.advisor-fetch-context(root.advisor-include-action-scores); }
                                        }
                                        Button {
                                            text: "Advisor once (no apply)";
                                            clicked => { root.advisor-once(false); }
                                        }
                                        Button {
                                            text: "Advisor once (apply)";
                                            clicked => { root.advisor-once(true); }
                                        }
                                    }

                                    if root.advisor-status != "": Text {
                                        text: root.advisor-status;
                                        color: Theme.text-secondary;
                                        font-size: 12px;
                                        wrap: word-wrap;
                                    }

                                    if root.advisor-context-json != "": VerticalBox {
                                        spacing: 4px;
                                        Text { text: "Last AdvisorContext (Braine → LLM)"; color: Theme.text-primary; font-size: 13px; font-weight: 600; }
                                        Text { text: root.advisor-context-json; color: Theme.text-secondary; font-size: 11px; wrap: word-wrap; }
                                    }

                                    if root.advisor-report-json != "": VerticalBox {
                                        spacing: 4px;
                                        Text { text: "Last AdvisorReport"; color: Theme.text-primary; font-size: 13px; font-weight: 600; }
                                        Text { text: root.advisor-report-json; color: Theme.text-secondary; font-size: 11px; wrap: word-wrap; }
                                    }
                                }
                            }
                        }
                    }

                    Tab {
                        title: "Brain Plot";
                        ScrollView {
                            horizontal-stretch: 1;
                            vertical-stretch: 1;
                            Rectangle {
                                background: Theme.bg-panel;
                                horizontal-stretch: 1;
                                VerticalBox {
                                    padding: 12px;
                                    spacing: 8px;

                                    Text {
                                        text: "Oscillation (sampled)";
                                        color: Theme.text-primary;
                                        font-size: 14px;
                                        font-weight: 600;
                                    }

                                    Rectangle {
                                        height: 120px;
                                        horizontal-stretch: 1;
                                        background: Theme.bg-dark;
                                        border-width: 1px;
                                        border-color: Theme.border;

                                        Rectangle {
                                            x: 0px;
                                            y: parent.height / 2;
                                            width: parent.width;
                                            height: 1px;
                                            background: #ffffff14;
                                        }

                                        property <int> n: root.osc-samples.length;

                                        for v[i] in root.osc-samples: Rectangle {
                                            width: 2px;
                                            height: 2px;
                                            property <float> vv: min(1.0, max(-1.0, v));
                                            x: (n <= 1) ? 0px : (i * (parent.width - self.width) / (n - 1));
                                            y: (0.5 - (vv * 0.45)) * (parent.height - self.height);
                                            background: Theme.accent-green;
                                        }
                                    }

                                    Text {
                                        text: "Units (sampled): amplitude vs age";
                                        color: Theme.text-primary;
                                        font-size: 14px;
                                        font-weight: 600;
                                    }

                                    // 3D-style unit plot container
                                    Rectangle {
                                        height: 280px;
                                        horizontal-stretch: 1;
                                        background: Theme.bg-dark;
                                        border-width: 1px;
                                        border-color: Theme.border;
                                        border-radius: 8px;
                                        clip: true;
                                        
                                        // Grid lines for depth effect
                                        for i in 10: Rectangle {
                                            width: 1px;
                                            height: parent.height;
                                            x: (i + 1) * parent.width / 11;
                                            background: Theme.border;
                                            opacity: 0.3;
                                        }
                                        for i in 5: Rectangle {
                                            width: parent.width;
                                            height: 1px;
                                            y: (i + 1) * parent.height / 6;
                                            background: Theme.border;
                                            opacity: 0.3;
                                        }

                                        // Unit points with 3D-style sizing
                                        for p in unit-points: Rectangle {
                                            // Size varies by unit type (sensor largest, reserved smallest)
                                            property <length> base-size: p.is_sensor_member ? 10px : (p.is_group_member ? 8px : (p.is_reserved ? 4px : 6px));
                                            width: self.base-size;
                                            height: self.base-size;
                                            border-radius: self.base-size / 2;
                                            x: p.rel_age * (parent.width - self.width);
                                            y: (1.0 - p.amp01) * (parent.height - self.height);
                                            background: p.is_reserved ? #888888 : (p.is_sensor_member ? Theme.accent-blue : (p.is_group_member ? Theme.accent-green : Theme.accent-yellow));
                                            opacity: p.is_reserved ? 0.5 : (p.is_sensor_member ? 1.0 : (p.is_group_member ? 0.9 : 0.8));
                                            
                                            // Glow effect for sensor/group units
                                            if !p.is_reserved: Rectangle {
                                                width: parent.width * 2;
                                                height: parent.height * 2;
                                                x: -parent.width / 2;
                                                y: -parent.height / 2;
                                                border-radius: self.width / 2;
                                                background: parent.background;
                                                opacity: 0.2;
                                            }
                                        }
                                        
                                        // Axis labels
                                        Text {
                                            x: 4px;
                                            y: 4px;
                                            text: "1.0";
                                            color: Theme.text-secondary;
                                            font-size: 10px;
                                        }
                                        Text {
                                            x: 4px;
                                            y: parent.height - 16px;
                                            text: "0.0";
                                            color: Theme.text-secondary;
                                            font-size: 10px;
                                        }
                                        Text {
                                            x: parent.width - 24px;
                                            y: parent.height - 16px;
                                            text: "new";
                                            color: Theme.text-secondary;
                                            font-size: 10px;
                                        }
                                        Text {
                                            x: 24px;
                                            y: parent.height - 16px;
                                            text: "old";
                                            color: Theme.text-secondary;
                                            font-size: 10px;
                                        }
                                    }

                                    // Legend with color swatches
                                    HorizontalLayout {
                                        spacing: 16px;
                                        padding: 8px;
                                        alignment: center;
                                        
                                        HorizontalLayout {
                                            spacing: 4px;
                                            Rectangle { width: 10px; height: 10px; border-radius: 5px; background: Theme.accent-blue; }
                                            Text { text: "Sensor"; color: Theme.text-secondary; font-size: 11px; }
                                        }
                                        HorizontalLayout {
                                            spacing: 4px;
                                            Rectangle { width: 8px; height: 8px; border-radius: 4px; background: Theme.accent-green; }
                                            Text { text: "Group"; color: Theme.text-secondary; font-size: 11px; }
                                        }
                                        HorizontalLayout {
                                            spacing: 4px;
                                            Rectangle { width: 6px; height: 6px; border-radius: 3px; background: Theme.accent-yellow; }
                                            Text { text: "Other"; color: Theme.text-secondary; font-size: 11px; }
                                        }
                                        HorizontalLayout {
                                            spacing: 4px;
                                            Rectangle { width: 4px; height: 4px; border-radius: 2px; background: #888888; opacity: 0.6; }
                                            Text { text: "Reserved"; color: Theme.text-secondary; font-size: 11px; }
                                        }
                                    }

                                    Rectangle { height: 1px; background: Theme.border; }

                                    Text {
                                        text: "Action preference (habit vs meaning)";
                                        color: Theme.text-primary;
                                        font-size: 13px;
                                        font-weight: 600;
                                    }

                                    ScrollView {
                                        height: 180px;
                                        horizontal-stretch: 1;
                                        VerticalBox {
                                            spacing: 4px;
                                            for s in action-scores: Text {
                                                text: s.name + " h=" + round(s.habit_norm * 1000) / 1000 + " m=" + round(s.meaning * 1000) / 1000 + " s=" + round(s.score * 1000) / 1000;
                                                color: Theme.text-secondary;
                                                font-size: 12px;
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }

                    Tab {
                        title: "Meaning";
                        ScrollView {
                            horizontal-stretch: 1;
                            vertical-stretch: 1;
                            Rectangle {
                                background: Theme.bg-panel;
                                horizontal-stretch: 1;
                                VerticalBox {
                                    padding: 12px;
                                    spacing: 8px;

                                    Text {
                                        text: "Meaning evidence (reward edges)";
                                        color: Theme.text-primary;
                                        font-size: 14px;
                                        font-weight: 600;
                                    }

                                    Text {
                                        text: "Stimulus: " + meaning.stimulus + "  correct: " + meaning.correct-action;
                                        color: Theme.text-secondary;
                                        font-size: 12px;
                                    }

                                    Text {
                                        text: "pair(stim, " + meaning.action-a-name + ") m=" + round(meaning.pair-left.meaning * 1000) / 1000;
                                        color: Theme.text-secondary;
                                        font-size: 12px;
                                    }
                                    Text {
                                        text: "pair(stim, " + meaning.action-b-name + ") m=" + round(meaning.pair-right.meaning * 1000) / 1000;
                                        color: Theme.text-secondary;
                                        font-size: 12px;
                                    }

                                    Rectangle { height: 1px; background: Theme.border; }

                                    Text {
                                        text: "Gaps: pair=" + round(meaning.pair-gap * 1000) / 1000 + " global=" + round(meaning.global-gap * 1000) / 1000;
                                        color: Theme.text-secondary;
                                        font-size: 12px;
                                    }

                                    Text { text: "Pair gap history"; color: Theme.text-primary; font-size: 13px; font-weight: 600; }
                                    Rectangle {
                                        height: 110px;
                                        horizontal-stretch: 1;
                                        background: Theme.bg-dark;
                                        border-width: 1px;
                                        border-color: Theme.border;

                                        Rectangle { x: 0px; y: parent.height / 2; width: parent.width; height: 1px; background: Theme.border; }

                                        for d in meaning-pair-gap-dots: Rectangle {
                                            width: 5px;
                                            height: 5px;
                                            x: d.x01 * (parent.width - self.width);
                                            y: (0.5 - 0.45 * d.v) * (parent.height - self.height);
                                            background: d.positive ? Theme.accent-green : Theme.accent-red;
                                        }
                                    }

                                    Text { text: "Global gap history"; color: Theme.text-primary; font-size: 13px; font-weight: 600; }
                                    Rectangle {
                                        height: 110px;
                                        horizontal-stretch: 1;
                                        background: Theme.bg-dark;
                                        border-width: 1px;
                                        border-color: Theme.border;

                                        Rectangle { x: 0px; y: parent.height / 2; width: parent.width; height: 1px; background: Theme.border; }

                                        for d in meaning-global-gap-dots: Rectangle {
                                            width: 5px;
                                            height: 5px;
                                            x: d.x01 * (parent.width - self.width);
                                            y: (0.5 - 0.45 * d.v) * (parent.height - self.height);
                                            background: d.positive ? Theme.accent-green : Theme.accent-red;
                                        }
                                    }
                                }
                            }
                        }
                    }

                    Tab {
                        title: "Graph";
                        ScrollView {
                            horizontal-stretch: 1;
                            vertical-stretch: 1;
                            Rectangle {
                                background: Theme.bg-panel;
                                horizontal-stretch: 1;
                                VerticalBox {
                                    padding: 12px;
                                    spacing: 8px;

                                    Text {
                                        text: "Connectivity Graph";
                                        color: Theme.text-primary;
                                        font-size: 14px;
                                        font-weight: 600;
                                    }

                                    HorizontalBox {
                                        spacing: 8px;
                                        Text { text: "Kind:"; color: Theme.text-secondary; vertical-alignment: center; }
                                        Button {
                                            text: (root.graph-kind == "causal") ? "Causal" : "Substrate";
                                            clicked => {
                                                root.graph-kind = (root.graph-kind == "causal") ? "substrate" : "causal";
                                                graph-request(root.graph-kind, root.graph-max-nodes, root.graph-max-edges, root.graph-include-isolated);
                                            }
                                        }
                                        Text { text: "Layout:"; color: Theme.text-secondary; vertical-alignment: center; }
                                        Button {
                                            text: (root.graph-layout == "circle") ? "Circle" : "Force";
                                            clicked => {
                                                root.graph-layout = (root.graph-layout == "circle") ? "force" : "circle";
                                            }
                                        }
                                        Rectangle { horizontal-stretch: 1; }
                                        Button {
                                            text: "Refresh";
                                            clicked => {
                                                graph-request(root.graph-kind, root.graph-max-nodes, root.graph-max-edges, root.graph-include-isolated);
                                            }
                                        }
                                    }

                                    HorizontalBox {
                                        spacing: 8px;
                                        Text { text: "Nodes:"; color: Theme.text-secondary; vertical-alignment: center; }
                                        Slider {
                                            minimum: 8;
                                            maximum: 1000;
                                            value: root.graph-max-nodes;
                                            changed(val) => { root.graph-max-nodes = val; }
                                            horizontal-stretch: 1;
                                        }
                                        Text { text: root.graph-max-nodes; color: Theme.text-secondary; vertical-alignment: center; }
                                        Text { text: "Edges:"; color: Theme.text-secondary; vertical-alignment: center; }
                                        Slider {
                                            minimum: 0;
                                            maximum: 50000;
                                            value: root.graph-max-edges;
                                            changed(val) => { root.graph-max-edges = val; }
                                            horizontal-stretch: 1;
                                        }
                                        Text { text: root.graph-max-edges; color: Theme.text-secondary; vertical-alignment: center; }
                                    }

                                    HorizontalBox {
                                        spacing: 8px;
                                        CheckBox { text: "Auto"; checked <=> root.graph-auto-refresh; }
                                        CheckBox {
                                            text: "Include isolated";
                                            checked <=> root.graph-include-isolated;
                                            toggled => {
                                                graph-request(root.graph-kind, root.graph-max-nodes, root.graph-max-edges, root.graph-include-isolated);
                                            }
                                        }
                                        Text { text: "Interval:"; color: Theme.text-secondary; vertical-alignment: center; }
                                        Slider {
                                            minimum: 250;
                                            maximum: 5000;
                                            value: root.graph-interval-ms;
                                            changed(val) => { root.graph-interval-ms = val; }
                                            horizontal-stretch: 1;
                                        }
                                        Text { text: root.graph-interval-ms; color: Theme.text-secondary; vertical-alignment: center; }
                                    }

                                    Text {
                                        text: root.graph-stats;
                                        color: Theme.text-secondary;
                                        font-size: 12px;
                                    }

                                    Rectangle {
                                        height: 360px;
                                        horizontal-stretch: 1;
                                        background: Theme.bg-dark;
                                        border-width: 1px;
                                        border-color: Theme.border;

                                        graph_viewport := Rectangle {
                                            x: 0px;
                                            y: 0px;
                                            width: parent.width;
                                            height: parent.height;
                                            background: transparent;
                                            clip: true;

                                            property <bool> dragging: false;
                                            property <float> drag-start-x01: 0.0;
                                            property <float> drag-start-y01: 0.0;
                                            property <float> pan-start-x01: 0.0;
                                            property <float> pan-start-y01: 0.0;

                                            hover_area := TouchArea {
                                                width: parent.width;
                                                height: parent.height;
                                                pointer-event(event) => {
                                                    let mx = self.mouse-x / parent.width;
                                                    let my = self.mouse-y / parent.height;
                                                    graph-hover(mx, my);
                                                }
                                                moved => {
                                                    let mx = self.mouse-x / parent.width;
                                                    let my = self.mouse-y / parent.height;
                                                    graph-hover(mx, my);

                                                    if self.pressed {
                                                        if !parent.dragging {
                                                            parent.dragging = true;
                                                            parent.drag-start-x01 = self.pressed-x / parent.width;
                                                            parent.drag-start-y01 = self.pressed-y / parent.height;
                                                            parent.pan-start-x01 = root.graph-pan-x01;
                                                            parent.pan-start-y01 = root.graph-pan-y01;
                                                        }
                                                        let dx = mx - parent.drag-start-x01;
                                                        let dy = my - parent.drag-start-y01;
                                                        root.graph-pan-x01 = max(-1.0, min(1.0, parent.pan-start-x01 + dx));
                                                        root.graph-pan-y01 = max(-1.0, min(1.0, parent.pan-start-y01 + dy));
                                                    } else {
                                                        parent.dragging = false;
                                                    }
                                                }
                                                scroll-event(event) => {
                                                    let dy = event.delta-y / 600px;
                                                    let factor = 1.0 + (-dy);
                                                    let old_zoom = root.graph-zoom;
                                                    let new_zoom = max(0.5, min(4.0, old_zoom * factor));
                                                    let mx = self.mouse-x / parent.width;
                                                    let my = self.mouse-y / parent.height;
                                                    let r = new_zoom / old_zoom;
                                                    root.graph-pan-x01 = max(-1.0, min(1.0, r * root.graph-pan-x01 + (1.0 - r) * (mx - 0.5)));
                                                    root.graph-pan-y01 = max(-1.0, min(1.0, r * root.graph-pan-y01 + (1.0 - r) * (my - 0.5)));
                                                    root.graph-zoom = new_zoom;
                                                    return accept;
                                                }
                                            }

                                            for e in graph-edge-segs: Path {
                                                commands:
                                                    "M "
                                                    + (e.x1 * ((parent.width - 8px) / 1px) + 4)
                                                    + " "
                                                    + (e.y1 * ((parent.height - 8px) / 1px) + 4)
                                                    + " L "
                                                    + (e.x2 * ((parent.width - 8px) / 1px) + 4)
                                                    + " "
                                                    + (e.y2 * ((parent.height - 8px) / 1px) + 4);
                                                viewbox-x: 0;
                                                viewbox-y: 0;
                                                viewbox-width: parent.width / 1px;
                                                viewbox-height: parent.height / 1px;
                                                fill: transparent;
                                                // Brighter edge colors for visibility on dark background.
                                                stroke: e.positive ? #4ade80 : #fb7185;
                                                // Keep a visible baseline width; thickness01 still encodes strength.
                                                stroke-width: (0.0025 + 0.0100 * e.thickness01) * min(parent.width, parent.height);
                                                stroke-line-cap: round;
                                                // Ensure even weak edges are visible; strength01 increases prominence.
                                                opacity: 0.35 + 0.65 * e.strength01;
                                            }

                                            for n in graph-nodes: Rectangle {
                                                width: 8px;
                                                height: 8px;
                                                x: n.x01 * (parent.width - self.width);
                                                y: n.y01 * (parent.height - self.height);
                                                background: (root.graph-kind == "causal")
                                                    ? (n.domain == "pos_x" ? Theme.accent-yellow :
                                                       n.domain == "pos_y" ? Theme.accent-green :
                                                       Theme.accent-blue)
                                                    : Theme.accent-blue;
                                                border-radius: 4px;
                                            }
                                        }

                                        if root.graph-hover-visible: Rectangle {
                                            background: Theme.bg-panel;
                                            border-width: 1px;
                                            border-color: Theme.border;
                                            border-radius: 4px;
                                            width: 260px;
                                            height: 28px;
                                            z: 2;
                                            x: ((root.graph-hover-x01 * graph_viewport.width + 12px) > (graph_viewport.width - self.width - 8px))
                                                ? (graph_viewport.width - self.width - 8px)
                                                : (root.graph-hover-x01 * graph_viewport.width + 12px);
                                            y: ((root.graph-hover-y01 * graph_viewport.height + 12px) > (graph_viewport.height - self.height - 8px))
                                                ? (graph_viewport.height - self.height - 8px)
                                                : (root.graph-hover-y01 * graph_viewport.height + 12px);

                                            Text {
                                                x: 6px;
                                                y: 4px;
                                                width: parent.width - 12px;
                                                height: parent.height - 8px;
                                                text: root.graph-hover-text;
                                                color: Theme.text-primary;
                                                font-size: 12px;
                                                horizontal-alignment: left;
                                                vertical-alignment: center;
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }

                    Tab {
                        title: "About";
                        AboutPanel { }
                    }
                    
                    Tab {
                        title: "Inferencing";
                        TabWidget {
                            horizontal-stretch: 1;
                            vertical-stretch: 1;

                            Tab {
                                title: "Prediction";
                                ScrollView {
                                    Rectangle {
                                        background: Theme.bg-panel;
                                        horizontal-stretch: 1;
                                        VerticalBox {
                                            padding: 12px;
                                            spacing: 8px;
                                            Text { text: "Prediction"; color: Theme.text-primary; font-size: 14px; font-weight: 600; }
                                            Text { text: "UI scaffold: expose sequence/next-step prediction tasks here."; color: Theme.text-secondary; font-size: 12px; wrap: word-wrap; }
                                        }
                                    }
                                }
                            }

                            Tab {
                                title: "Classification";
                                ScrollView {
                                    Rectangle {
                                        background: Theme.bg-panel;
                                        horizontal-stretch: 1;
                                        VerticalBox {
                                            padding: 12px;
                                            spacing: 8px;
                                            Text { text: "Classification"; color: Theme.text-primary; font-size: 14px; font-weight: 600; }
                                            Text { text: "UI scaffold: map observations to labels; track accuracy and confusion."; color: Theme.text-secondary; font-size: 12px; wrap: word-wrap; }
                                        }
                                    }
                                }
                            }

                            Tab {
                                title: "Scoring / Ranking";
                                ScrollView {
                                    Rectangle {
                                        background: Theme.bg-panel;
                                        horizontal-stretch: 1;
                                        VerticalBox {
                                            padding: 12px;
                                            spacing: 8px;
                                            Text { text: "Scoring / Ranking"; color: Theme.text-primary; font-size: 14px; font-weight: 600; }
                                            Text { text: "UI scaffold: display action scores, candidate rankings, and calibration."; color: Theme.text-secondary; font-size: 12px; wrap: word-wrap; }
                                        }
                                    }
                                }
                            }

                            Tab {
                                title: "Control";
                                ScrollView {
                                    Rectangle {
                                        background: Theme.bg-panel;
                                        horizontal-stretch: 1;
                                        VerticalBox {
                                            padding: 12px;
                                            spacing: 8px;
                                            Text { text: "Control & Action Selection"; color: Theme.text-primary; font-size: 14px; font-weight: 600; }
                                            Text { text: "UI scaffold: configure exploration, policies, and closed-loop control."; color: Theme.text-secondary; font-size: 12px; wrap: word-wrap; }
                                        }
                                    }
                                }
                            }

                            Tab {
                                title: "Decision Making";
                                ScrollView {
                                    Rectangle {
                                        background: Theme.bg-panel;
                                        horizontal-stretch: 1;
                                        VerticalBox {
                                            padding: 12px;
                                            spacing: 8px;
                                            Text { text: "Decision Making / Problem Solving"; color: Theme.text-primary; font-size: 14px; font-weight: 600; }
                                            Text { text: "UI scaffold: integrate experts + nesting for recursive problem solving."; color: Theme.text-secondary; font-size: 12px; wrap: word-wrap; }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
    }
}
