// Braine Desktop - UI Panels
// Reusable panel components for the main window

import { VerticalBox, HorizontalBox, Button, Slider, CheckBox } from "std-widgets.slint";
import { Theme } from "theme.slint";
import { HudData, LearningState, BrainStats, GameState, MeaningHistDot } from "types.slint";

// ═══════════════════════════════════════════════════════════════════════════
// Game header (title + short instructions)
// ═══════════════════════════════════════════════════════════════════════════

export component GameHeader inherits Rectangle {
    in property <string> kind;
    in property <GameState> game;

    background: transparent;
    border-width: 0px;

    property <string> title_text:
        (kind == "bandit") ? "Bandit" :
        (kind == "spot_reversal") ? "Spot Reversal" :
        (kind == "spotxy") ? "SpotXY" :
        (kind == "pong") ? "Pong" :
        (kind == "text") ? "Text" :
        (kind == "replay") ? "Replay" :
        "Spot";

    property <string> help_text:
        (kind == "pong") ? "Keys: W/Up = up, S/Down = down, Space = stay" :
        (kind == "bandit") ? "Two-armed bandit: rewards are stochastic; learn which arm pays." :
        (kind == "spotxy") ? "Track the dot (TRAIN) or holdout (EVAL)." :
        (kind == "spot_reversal") ? "Rule flips; context bit helps detect reversals." :
        (kind == "text") ? "Next-token prediction: observe token, choose the next token." :
        (kind == "replay") ? "Dataset-driven trials: reward is computed from correctness." :
        "Discriminate left vs right spot.";

    VerticalBox {
        spacing: 2px;
        Text {
            text: title_text;
            color: Theme.text-primary;
            font-size: 14px;
            font-weight: 600;
        }
        Text {
            text: help_text;
            color: Theme.text-secondary;
            font-size: 12px;
            wrap: word-wrap;
        }

        if kind == "text": Text {
            text: "regime=" + game.text-regime +
                  " token=" + game.text-token +
                  " target_next=" + game.text-target-next +
                  " vocab=" + game.text-vocab-size;
            color: Theme.text-secondary;
            font-size: 12px;
        }

        if kind == "replay": Text {
            text: "dataset=" + game.replay-dataset +
                  " trial=" + game.replay-index + "/" + game.replay-total +
                  ((game.replay-trial-id != "") ? (" id=" + game.replay-trial-id) : "");
            color: Theme.text-secondary;
            font-size: 12px;
        }
    }
}

// ═══════════════════════════════════════════════════════════════════════════
// HUD Panel
// ═══════════════════════════════════════════════════════════════════════════

export component HudPanel inherits Rectangle {
    in property <HudData> hud;
    in property <int> trial-ms: 250;

    property <float> trial_s: (trial-ms <= 0) ? 0.25 : (trial-ms * 1.0) / 1000.0;
    
    background: Theme.bg-panel;
    border-color: Theme.border;
    border-width: 1px;
    border-radius: 6px;
    
    VerticalBox {
        padding: 10px;
        spacing: 4px;
        
        Text {
            text: "Frame: " + hud.frame + "  Trials: " + hud.trials;
            color: Theme.text-primary;
            font-size: 13px;
        }
        Text {
            text: "Correct: " + hud.correct + "  Incorrect: " + hud.incorrect + "  Accuracy: " + round(hud.accuracy * 100) + "%";
            color: Theme.text-primary;
            font-size: 13px;
        }
        Text {
            text: "Recent: " + round(hud.recent-rate * 100) + "%  Last 100: " + round(hud.last-100-rate * 100) + "%";
            color: hud.last-100-rate >= 0.85 ? Theme.accent-green : Theme.text-secondary;
            font-size: 13px;
        }
        Text {
            text: "Neuromodulator: " + round(hud.neuromod * 1000) / 1000;
            color: Theme.text-secondary;
            font-size: 12px;
        }
        
        // Learning milestones
        Text {
            text: hud.last-100-rate >= 0.95 ? "MASTERED" : 
                hud.last-100-rate >= 0.85 ? "LEARNED" :
                hud.last-100-rate >= 0.70 ? "LEARNING" :
                  hud.trials < 20 ? "Starting..." : "Not yet learned";
            color: hud.last-100-rate >= 0.85 ? Theme.accent-green : Theme.accent-yellow;
            font-size: 14px;
            font-weight: 600;
        }

        Text {
            text: "Reached @ trials — Learning: " + (hud.learning-at-trial < 0 ? "-" : hud.learning-at-trial) +
                  "  Learned: " + (hud.learned-at-trial < 0 ? "-" : hud.learned-at-trial) +
                  "  Mastered: " + (hud.mastered-at-trial < 0 ? "-" : hud.mastered-at-trial);
            color: Theme.text-secondary;
            font-size: 12px;
        }

        Text {
            text: "Approx time — Learning: " + (hud.learning-at-trial < 0 ? "-" : (round(hud.learning-at-trial * trial_s * 10) / 10 + "s")) +
                  "  Learned: " + (hud.learned-at-trial < 0 ? "-" : (round(hud.learned-at-trial * trial_s * 10) / 10 + "s")) +
                  "  Mastered: " + (hud.mastered-at-trial < 0 ? "-" : (round(hud.mastered-at-trial * trial_s * 10) / 10 + "s"));
            color: Theme.text-secondary;
            font-size: 12px;
        }
    }
}

// ═══════════════════════════════════════════════════════════════════════════
// Learning Panel
// ═══════════════════════════════════════════════════════════════════════════

export component LearningPanel inherits Rectangle {
    in-out property <LearningState> state;
    
    callback trigger-dream();
    callback trigger-burst();
    callback trigger-sync();
    callback trigger-imprint();
    callback set-framerate(int);
    callback set-trial-period-ms(int);
    
    in-out property <int> framerate: 60;
    in-out property <int> trial-period-ms: 250;
    
    background: Theme.bg-panel;
    border-color: Theme.border;
    border-width: 1px;
    border-radius: 6px;
    
    VerticalBox {
        padding: 12px;
        spacing: 8px;
        
        Text {
            text: "Accelerated Learning";
            color: Theme.text-primary;
            font-size: 14px;
            font-weight: 600;
        }
        
        CheckBox {
            text: "Learning Enabled";
            checked: state.learning-enabled;
            toggled => { state.learning-enabled = self.checked; }
        }
        
        HorizontalBox {
            spacing: 6px;
            Button {
                text: "Dream";
                clicked => { trigger-dream(); }
            }
            Button {
                text: "Burst";
                clicked => { trigger-burst(); }
            }
            Button {
                text: "Sync";
                clicked => { trigger-sync(); }
            }
            Button {
                text: "Imprint";
                clicked => { trigger-imprint(); }
            }
        }

        Text {
            text: "Dream: offline replay to consolidate recent structure (stabilizes what just worked).";
            color: Theme.text-secondary;
            font-size: 12px;
            wrap: word-wrap;
        }
        Text {
            text: "Burst: temporary learning-rate boost (helps rapid adaptation; can increase drift if overused).";
            color: Theme.text-secondary;
            font-size: 12px;
            wrap: word-wrap;
        }
        Text {
            text: "Sync: aligns sensor phases for cleaner encoding (use after a regime shift / reversal).";
            color: Theme.text-secondary;
            font-size: 12px;
            wrap: word-wrap;
        }
        Text {
            text: "Imprint: one-shot linking of the current context (fast association when the brain is missing a concept).";
            color: Theme.text-secondary;
            font-size: 12px;
            wrap: word-wrap;
        }
        
        Rectangle {
            height: 1px;
            background: Theme.border;
        }
        
        Text {
            text: "Simulation Speed";
            color: Theme.text-primary;
            font-size: 14px;
            font-weight: 600;
        }
        
        HorizontalBox {
            spacing: 8px;
            Text {
                text: "FPS: " + framerate;
                color: Theme.text-secondary;
                font-size: 12px;
                min-width: 60px;
            }
            Slider {
                minimum: 1;
                maximum: 120;
                value: framerate;
                changed(val) => {
                    framerate = val;
                    set-framerate(val);
                }
                horizontal-stretch: 1;
            }
            Button {
                text: "Reset";
                clicked => {
                    framerate = 60;
                    set-framerate(60);
                }
            }
        }

        HorizontalBox {
            spacing: 8px;
            Text {
                text: "Trial: " + trial-period-ms + "ms";
                color: Theme.text-secondary;
                font-size: 12px;
                min-width: 100px;
            }
            Slider {
                minimum: 50;
                maximum: 2000;
                value: trial-period-ms;
                changed(val) => {
                    trial-period-ms = val;
                    set-trial-period-ms(val);
                }
                horizontal-stretch: 1;
            }
            Button {
                text: "Reset";
                clicked => {
                    trial-period-ms = 250;
                    set-trial-period-ms(250);
                }
            }
        }
    }
}

// ═══════════════════════════════════════════════════════════════════════════
// Brain Stats Panel
// ═══════════════════════════════════════════════════════════════════════════

export component BrainPanel inherits Rectangle {
    in property <BrainStats> stats;
    in property <[MeaningHistDot]> learning-eligibility-dots;
    in property <[MeaningHistDot]> learning-plasticity-dots;
    in property <[MeaningHistDot]> learning-homeostasis-bias-dots;
    in property <string> experts-status;
    in property <bool> experts-enabled;
    in-out property <bool> experts-allow-nested;
    in-out property <int> experts-max-depth;

    in-out property <string> experts-parent-learning;
    in-out property <int> experts-max-children;
    in-out property <float> experts-child-reward-scale;
    in-out property <int> experts-episode-trials;
    in-out property <int> experts-consolidate-topk;
    in-out property <string> experts-persistence-mode;
    in-out property <float> experts-reward-shift-ema-delta-threshold;
    in-out property <float> experts-performance-collapse-drop-threshold;
    in-out property <float> experts-performance-collapse-baseline-min;
    callback set-max-units(int);
    callback experts-enabled-changed(bool);
    callback experts-nesting-changed(bool, int);
    callback experts-policy-apply(string, int, float, int, int, float, float, float, string, bool, int);
    callback cull-experts();
    
    background: Theme.bg-panel;
    border-color: Theme.border;
    border-width: 1px;
    border-radius: 6px;
    
    VerticalBox {
        padding: 12px;
        spacing: 6px;
        
        Text {
            text: "Brain Substrate";
            color: Theme.text-primary;
            font-size: 14px;
            font-weight: 600;
        }

        if experts-status != "": Text {
            text: experts-status;
            color: Theme.text-secondary;
            font-size: 12px;
        }

        HorizontalBox {
            spacing: 10px;
            CheckBox {
                text: "Experts";
                checked: experts-enabled;
                toggled => { experts-enabled-changed(self.checked); }
            }
            Button {
                text: "Cull";
                enabled: experts-enabled;
                clicked => { cull-experts(); }
            }
            Text {
                text: experts-enabled ? "(plots/graphs can switch to Active Expert)" : "(enable to allow child brains)";
                color: Theme.text-secondary;
                vertical-alignment: center;
                font-size: 12px;
            }
        }

        HorizontalBox {
            spacing: 10px;
            CheckBox {
                text: "Allow nesting";
                enabled: experts-enabled;
                checked: experts-allow-nested;
                toggled => { experts-nesting-changed(self.checked, experts-max-depth); }
            }
            Text {
                text: "Max depth:";
                color: Theme.text-secondary;
                vertical-alignment: center;
                font-size: 12px;
            }
            Slider {
                minimum: 1;
                maximum: 8;
                enabled: experts-enabled && experts-allow-nested;
                value: experts-max-depth;
                changed(val) => {
                    experts-max-depth = val;
                    experts-nesting-changed(experts-allow-nested, experts-max-depth);
                }
                horizontal-stretch: 1;
            }
            Text {
                text: experts-max-depth;
                color: Theme.text-secondary;
                vertical-alignment: center;
                font-size: 12px;
                min-width: 18px;
            }
        }

        Rectangle {
            height: 1px;
            horizontal-stretch: 1;
            background: Theme.border;
        }

        Text {
            text: "Expert policy";
            color: Theme.text-primary;
            font-size: 13px;
            font-weight: 600;
        }

        HorizontalBox {
            spacing: 10px;
            Text { text: "Parent learning:"; color: Theme.text-secondary; vertical-alignment: center; font-size: 12px; }
            Button {
                enabled: experts-enabled;
                text: experts-parent-learning;
                clicked => {
                    experts-parent-learning = (experts-parent-learning == "holdout") ? "reduced" :
                                            (experts-parent-learning == "reduced") ? "normal" : "holdout";
                }
            }
            Text { text: "Persist:"; color: Theme.text-secondary; vertical-alignment: center; font-size: 12px; }
            Button {
                enabled: experts-enabled;
                text: experts-persistence-mode;
                clicked => {
                    experts-persistence-mode = (experts-persistence-mode == "drop_active") ? "full" : "drop_active";
                }
            }
        }

        HorizontalBox {
            spacing: 8px;
            Text { text: "Max children:"; color: Theme.text-secondary; vertical-alignment: center; font-size: 12px; }
            Slider {
                minimum: 0;
                maximum: 8;
                enabled: experts-enabled;
                value: experts-max-children;
                changed(val) => { experts-max-children = val; }
                horizontal-stretch: 1;
            }
            Text { text: experts-max-children; color: Theme.text-secondary; vertical-alignment: center; font-size: 12px; min-width: 18px; }
        }

        HorizontalBox {
            spacing: 8px;
            Text { text: "Reward scale:"; color: Theme.text-secondary; vertical-alignment: center; font-size: 12px; }
            Slider {
                minimum: 0.0;
                maximum: 4.0;
                enabled: experts-enabled;
                value: experts-child-reward-scale;
                changed => { experts-child-reward-scale = self.value; }
                horizontal-stretch: 1;
            }
            Text { text: "" + (round(experts-child-reward-scale * 100.0) / 100.0); color: Theme.text-secondary; vertical-alignment: center; font-size: 12px; min-width: 36px; }
        }

        HorizontalBox {
            spacing: 8px;
            Text { text: "Episode trials:"; color: Theme.text-secondary; vertical-alignment: center; font-size: 12px; }
            Slider {
                minimum: 1;
                maximum: 256;
                enabled: experts-enabled;
                value: experts-episode-trials;
                changed(val) => { experts-episode-trials = val; }
                horizontal-stretch: 1;
            }
            Text { text: experts-episode-trials; color: Theme.text-secondary; vertical-alignment: center; font-size: 12px; min-width: 32px; }
        }

        HorizontalBox {
            spacing: 8px;
            Text { text: "Consolidate top-k:"; color: Theme.text-secondary; vertical-alignment: center; font-size: 12px; }
            Slider {
                minimum: 0;
                maximum: 1000;
                enabled: experts-enabled;
                value: experts-consolidate-topk;
                changed(val) => { experts-consolidate-topk = val; }
                horizontal-stretch: 1;
            }
            Text { text: experts-consolidate-topk; color: Theme.text-secondary; vertical-alignment: center; font-size: 12px; min-width: 42px; }
        }

        HorizontalBox {
            spacing: 8px;
            Text { text: "Shift ΔEMA:"; color: Theme.text-secondary; vertical-alignment: center; font-size: 12px; }
            Slider {
                minimum: 0.0;
                maximum: 2.0;
                enabled: experts-enabled;
                value: experts-reward-shift-ema-delta-threshold;
                changed => { experts-reward-shift-ema-delta-threshold = self.value; }
                horizontal-stretch: 1;
            }
            Text {
                text: "" + (round(experts-reward-shift-ema-delta-threshold * 100.0) / 100.0);
                color: Theme.text-secondary;
                vertical-alignment: center;
                font-size: 12px;
                min-width: 36px;
            }
        }

        HorizontalBox {
            spacing: 8px;
            Text { text: "Collapse drop:"; color: Theme.text-secondary; vertical-alignment: center; font-size: 12px; }
            Slider {
                minimum: 0.0;
                maximum: 2.0;
                enabled: experts-enabled;
                value: experts-performance-collapse-drop-threshold;
                changed => { experts-performance-collapse-drop-threshold = self.value; }
                horizontal-stretch: 1;
            }
            Text {
                text: "" + (round(experts-performance-collapse-drop-threshold * 100.0) / 100.0);
                color: Theme.text-secondary;
                vertical-alignment: center;
                font-size: 12px;
                min-width: 36px;
            }
        }

        HorizontalBox {
            spacing: 8px;
            Text { text: "Collapse baseline:"; color: Theme.text-secondary; vertical-alignment: center; font-size: 12px; }
            Slider {
                minimum: -1.0;
                maximum: 1.0;
                enabled: experts-enabled;
                value: experts-performance-collapse-baseline-min;
                changed => { experts-performance-collapse-baseline-min = self.value; }
                horizontal-stretch: 1;
            }
            Text {
                text: "" + (round(experts-performance-collapse-baseline-min * 100.0) / 100.0);
                color: Theme.text-secondary;
                vertical-alignment: center;
                font-size: 12px;
                min-width: 36px;
            }
        }

        HorizontalBox {
            spacing: 10px;
            Button {
                text: "Apply policy";
                enabled: experts-enabled;
                clicked => {
                    experts-policy-apply(
                        experts-parent-learning,
                        experts-max-children,
                        experts-child-reward-scale,
                        experts-episode-trials,
                        experts-consolidate-topk,
                        experts-reward-shift-ema-delta-threshold,
                        experts-performance-collapse-drop-threshold,
                        experts-performance-collapse-baseline-min,
                        experts-persistence-mode,
                        experts-allow-nested,
                        experts-max-depth
                    );
                }
            }
            Text {
                text: "(applies to existing experts too)";
                color: Theme.text-secondary;
                vertical-alignment: center;
                font-size: 12px;
            }
        }
        Text { text: "Units: " + stats.unit-count; color: Theme.text-secondary; font-size: 12px; }
        HorizontalBox {
            spacing: 8px;
            Text { text: "Max units: " + stats.max-units-limit; color: Theme.text-secondary; font-size: 12px; vertical-alignment: center; }
            Button { text: "-32"; clicked => { set-max-units(stats.max-units-limit - 32); } }
            Button { text: "+32"; clicked => { set-max-units(stats.max-units-limit + 32); } }
        }
        Text { text: "Connections: " + stats.connection-count; color: Theme.text-secondary; font-size: 12px; }
        Text { text: "Pruned (last): " + stats.pruned-last-step; color: Theme.text-secondary; font-size: 12px; }
        Text { text: "Births (last): " + stats.births-last-step; color: Theme.text-secondary; font-size: 12px; }
        Text { text: "Saturated: " + (stats.saturated ? "yes" : "no"); color: stats.saturated ? Theme.accent-yellow : Theme.text-secondary; font-size: 12px; }
        Text { text: "Causal symbols: " + stats.causal-base-symbols; color: Theme.text-secondary; font-size: 12px; }
        Text { text: "Causal edges: " + stats.causal-edges; color: Theme.text-secondary; font-size: 12px; }
        Text { text: "Causal updates (last): " + stats.causal-last-directed-updates + " dir, " + stats.causal-last-cooccur-updates + " co"; color: Theme.text-secondary; font-size: 12px; }
        Text { text: "Avg amplitude: " + round(stats.avg-amp * 1000) / 1000; color: Theme.text-secondary; font-size: 12px; }
        Text { text: "Avg weight: " + round(stats.avg-weight * 1000) / 1000; color: Theme.text-secondary; font-size: 12px; }

        Rectangle { height: 1px; horizontal-stretch: 1; background: Theme.border; }

        Text {
            text: "Learning monitors";
            color: Theme.text-primary;
            font-size: 13px;
            font-weight: 600;
        }

        Text {
            text: "elig L1=" + (round(stats.eligibility-l1 * 100) / 100) +
                  "  |Δw| L1=" + (round(stats.plasticity-l1 * 100) / 100) +
                  "  edges=" + stats.plasticity-edges +
                  "  commit=" + (stats.plasticity-committed ? "yes" : "no");
            color: Theme.text-secondary;
            font-size: 12px;
        }

        if stats.plasticity-budget > 0.0: Text {
            text: "budget=" + (round(stats.plasticity-budget * 100) / 100) +
                  "  used=" + (round(stats.plasticity-budget-used * 100) / 100) +
                  "  deadband=" + (round(stats.learning-deadband * 1000) / 1000);
            color: Theme.text-secondary;
            font-size: 12px;
        }

        if stats.homeostasis-rate > 0.0: Text {
            text: "homeostasis rate=" + (round(stats.homeostasis-rate * 1000) / 1000) +
                  "  bias L1=" + (round(stats.homeostasis-bias-l1 * 1000) / 1000);
            color: Theme.text-secondary;
            font-size: 12px;
        }

        Rectangle {
            height: 52px;
            horizontal-stretch: 1;
            background: Theme.bg-dark;
            border-width: 1px;
            border-color: Theme.border;

            // Plasticity sparkline (bars).
            for d in learning-plasticity-dots: Rectangle {
                width: 3px;
                height: abs(d.v) * (parent.height - 6px);
                x: d.x01 * (parent.width - self.width);
                y: parent.height - self.height;
                background: Theme.accent-blue;
            }
        }

        Rectangle {
            height: 52px;
            horizontal-stretch: 1;
            background: Theme.bg-dark;
            border-width: 1px;
            border-color: Theme.border;

            // Eligibility sparkline (bars).
            for d in learning-eligibility-dots: Rectangle {
                width: 3px;
                height: abs(d.v) * (parent.height - 6px);
                x: d.x01 * (parent.width - self.width);
                y: parent.height - self.height;
                background: Theme.accent-green;
            }
        }

        if stats.homeostasis-rate > 0.0: Rectangle {
            height: 52px;
            horizontal-stretch: 1;
            background: Theme.bg-dark;
            border-width: 1px;
            border-color: Theme.border;

            // Homeostasis bias sparkline (dots around midline).
            Rectangle { x: 0px; y: parent.height / 2; width: parent.width; height: 1px; background: Theme.border; }
            for d in learning-homeostasis-bias-dots: Rectangle {
                width: 5px;
                height: 5px;
                x: d.x01 * (parent.width - self.width);
                y: (0.5 - 0.45 * d.v) * (parent.height - self.height);
                background: d.positive ? Theme.accent-green : Theme.accent-red;
            }
        }

        Text { text: "Memory: " + stats.memory-bytes + " bytes"; color: Theme.text-secondary; font-size: 12px; }
        Text { text: "Age: " + stats.age-steps + " steps"; color: Theme.text-secondary; font-size: 12px; }
    }
}
